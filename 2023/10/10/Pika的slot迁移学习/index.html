<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Pika的slot数据迁移学习 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="背景自 Pika 3.5.0 版本开始，Pika 支持 Codis + Pika 集群的模式">
<meta property="og:type" content="article">
<meta property="og:title" content="Pika的slot数据迁移学习">
<meta property="og:url" content="http://example.com/2023/10/10/Pika%E7%9A%84slot%E8%BF%81%E7%A7%BB%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="背景自 Pika 3.5.0 版本开始，Pika 支持 Codis + Pika 集群的模式">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/14285659-ece5-4944-8d32-03931b622e69">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/bf3244b1-21fc-452f-ae7d-adb3670a48c2">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/7aefc44a-6b12-40f7-b8c5-2c191a327167">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/74838918-5d0b-469d-9438-e79fa873f72f">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/f8a3cdff-571b-4196-9c46-d3f18790840c">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/d611233a-ffa4-41ef-aa04-4406cbd0ce46">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/346d35c6-af76-482a-bc2f-42cd303671c4">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/2121d8d9-6b0b-452c-8243-db436d29c540">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/daba04af-8634-4966-b7aa-1d10d6e5a799">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/155baf02-e0f5-4b23-a94d-ac36d32a3cce">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/a751e969-c709-45d0-a407-344b28baab09">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/e58781c1-02e7-4b22-9d36-10a9defdf309">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/421984d9-eb25-48c0-8758-2abcff2ead51">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/f4e5c12b-423c-4feb-89d9-3b0befa71d8a">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/01327a27-86f7-4558-8c69-7a17d1659199">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/e1354403-28df-4382-a218-20df908daf12">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/084751d8-b1bd-4de3-b468-81c990cabc9f">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/e34e4597-a3ce-4281-8075-46f949685e84">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/1b92c474-0c4c-400e-a278-5b3b14a97a73">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/b0c515d7-6786-4789-9988-1d53ae0447eb">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/d866fe21-4697-43f2-b0d1-f617d043121a">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/16812d6d-3d36-424f-a796-6b859148a600">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/49f9135a-ba7e-4224-9bd3-790315848450">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/ac261b6e-8b1c-4a75-9a42-90db5889f6e8">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/f7765b00-9b1d-4473-8ae4-8a7f2384ba7f">
<meta property="article:published_time" content="2023-10-10T07:59:36.770Z">
<meta property="article:modified_time" content="2023-12-04T12:08:12.046Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/14285659-ece5-4944-8d32-03931b622e69">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-Pika的slot迁移学习" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/10/10/Pika%E7%9A%84slot%E8%BF%81%E7%A7%BB%E5%AD%A6%E4%B9%A0/" class="article-date">
  <time class="dt-published" datetime="2023-10-10T07:59:36.770Z" itemprop="datePublished">2023-10-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Pika的slot数据迁移学习
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>自 Pika 3.5.0 版本开始，Pika 支持 Codis + Pika 集群的模式<span id="more"></span>，实现方法是将 Codis 中的 redis-server 替换成为 pika-server，增加 slot key 的概念 （默认1024个，可以通过配置文件进行配置），以 set 类型举例，在用户对每个 key 进行修改操作时，根据 slot &#x3D; crc32(key) % 1024 计算出该 key 对应的 slot，然后将该 key 加到对应的 slot 中；迁移时，指定 slot，从该 slot 中 spop 出一个 key 然后迁移到目标 pika-server</p>
<p>当前的 Pika 的 slot 迁移方式包括以下几种</p>
<ul>
<li><p>指定范围内的 Slots 迁移到指定的 Group</p>
<img width="592" alt="截屏2023-12-04 19 49 18" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/14285659-ece5-4944-8d32-03931b622e69">


</li>
<li><p>指定数量的 Slots 从一个 Group 迁移到另一个 Group (从指定 Group 的头部 Slots 开始计算)</p>
<img width="633" alt="截屏2023-12-04 19 49 41" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/bf3244b1-21fc-452f-ae7d-adb3670a48c2">


</li>
<li><p>平均分配所有的 Slots，即 Rebalance All Slots</p>
<img width="864" alt="截屏2023-12-04 19 52 54" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/7aefc44a-6b12-40f7-b8c5-2c191a327167"></li>
</ul>
<p>目前的问题是 slot 的迁移速度很慢，具体原因体现在 slot 迁移时是以单个 slot 为粒度迁移，这对后续 Pika 进行自动扩缩容的性能存在影响</p>
<h1 id="讨论"><a href="#讨论" class="headerlink" title="讨论"></a>讨论</h1><ul>
<li><p>什么场景下需要用到 slot 迁移？</p>
<ol>
<li>新集群部署的时候，平均分配所有的 slot 到各个 Group 中，即 Rebalance All Slots<img width="829" alt="截屏2023-12-04 19 53 20" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/74838918-5d0b-469d-9438-e79fa873f72f"></li>
<li>扩容一个 Group 的时候，需要将其他 Group 上面的 slot 迁移到扩容的 Group 上，如果使用 Rebalance All Slots 的话会平均把每个 Group 中末尾的 slot 平均分给新的 Group</li>
</ol>
</li>
</ul>
<img width="848" alt="截屏2023-12-04 19 53 32" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/f8a3cdff-571b-4196-9c46-d3f18790840c">

<ol start="3">
<li><p>缩容一个 Group 的时候，需要将缩容的 Group 上面的 slot 上面的数据迁移到集群中其他的 Group 中，即平均迁移 slot 到各个 Group 上，最后才能下线这个 Group，目前还不能做到平均自动迁移，只能手动选择范围内的 slot 进行迁移，等把所有在缩容的 Group 上的 slot 迁移完之后，才能缩容这个 Group</p>
<p>​</p>
</li>
</ol>
<ul>
<li><p>迁移 slot 过程中实际用到的命令是哪些？</p>
<ol>
<li><p>slotsdel: 删除 Pika 中 slot 下的全部 key-value，不会删除原生的 key</p>
</li>
<li><p>slotscleanup: 删除 slotID 对应的 key，删除 slot 里面的 key 和 原生 key</p>
</li>
<li><p>slotsmgrtslot: 随机选择 slot 下的 1 个 key-value 迁移到目标机 (迁移原生的 key 和 slot)</p>
</li>
<li><p>slotsmgrttagslot: 随机选择 slot 下的 1 个 key-value 和该 key 相同 tag 的 key-value 迁移到目标机</p>
</li>
<li><p>slotsmgrtone: 迁移指定 key 到目标机 (迁移原生的 key 和 slot)</p>
</li>
<li><p>slotsmgrttagone: 迁移指定 key 和 key 有相同的 tag 的 key 到目标机 </p>
</li>
<li><p>slotsmgrtslot-async: 异步将指定 slot 里指定数量的 key 迁移到目标机器 (迁移原生的 key 和 slot)</p>
</li>
<li><p>slotsmgrttagslot-async: 异步将指定 slot 里指定数量的 key(带 tag) 迁移到目标机器</p>
<p>​</p>
</li>
</ol>
</li>
</ul>
<h1 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h1><h3 id="Codis-代码"><a href="#Codis-代码" class="headerlink" title="Codis 代码"></a>Codis 代码</h3><p>先说结论，在 Codis 中 Slot 迁移分为两种，一种是同步迁移，用的命令是 Pika 中的 <code>SLOTSMGRTTAGSLOT</code> ，这个命令用法如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; slotsmgrttagslot host port timeout slot</span><br><span class="line">&gt; slotsmgrttagslot <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">6380</span> <span class="number">100</span> <span class="number">579</span> # 随机选择slot下的<span class="number">1</span>个key-value以及和该key相同tag的key-value迁移到目标机</span><br><span class="line">&gt; (integer) <span class="number">1</span>  # 迁移成功</span><br></pre></td></tr></table></figure>

<p>另一种是异步迁移，用的命令是 Pika 中的 <code>SLOTSMGRTTAGSLOT-ASYNC</code>，这个命令用法如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; slotsmgrttagslot-async hostport timeout maxbulks maxbytes slot numkeys</span><br><span class="line">&gt; slotsmgrttagslot-async pika <span class="number">9221</span> <span class="number">5000</span> <span class="number">200</span> <span class="number">33554432</span> <span class="number">518</span> <span class="number">500</span> # 异步将指定slot里指定数量的key迁移到目标机器</span><br><span class="line">&gt; (integer) <span class="number">1</span>  # 迁移成功</span><br></pre></td></tr></table></figure>
<img width="931" alt="截屏2023-12-04 19 53 48" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/d611233a-ffa4-41ef-aa04-4406cbd0ce46">



<p>我们以 Migreate Range 按钮为例 (这个命令是将一定范围内的 slot 迁移到指定的 Group)，来看下它在 Codis 中的逻辑</p>
<img width="917" alt="截屏2023-12-04 19 54 07" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/346d35c6-af76-482a-bc2f-42cd303671c4">


<p>我们会调用 <code>SlotCreateActionRange</code>这个函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">func</span> (s *Topom) <span class="built_in">SlotCreateActionRange</span>(beg, end <span class="type">int</span>, gid <span class="type">int</span>, must <span class="type">bool</span>) error &#123;</span><br><span class="line">    ....</span><br><span class="line">	var pending []<span class="type">int</span></span><br><span class="line">	<span class="keyword">for</span> sid := beg; sid &lt;= end; sid++ &#123;</span><br><span class="line">		m, err := ctx.<span class="built_in">getSlotMapping</span>(sid)</span><br><span class="line">		<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> m.Action.State != models.ActionNothing &#123;</span><br><span class="line">			<span class="keyword">if</span> !must &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> errors.<span class="built_in">Errorf</span>(<span class="string">&quot;slot-[%d] action already exists&quot;</span>, sid)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> m.GroupId == g.Id &#123;</span><br><span class="line">			<span class="keyword">if</span> !must &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> errors.<span class="built_in">Errorf</span>(<span class="string">&quot;slot-[%d] already in group-[%d]&quot;</span>, sid, g.Id)</span><br><span class="line">		&#125;</span><br><span class="line">		pending = <span class="built_in">append</span>(pending, m.Id)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, sid := range pending &#123;</span><br><span class="line">		m, err := ctx.<span class="built_in">getSlotMapping</span>(sid)</span><br><span class="line">		<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		defer s.<span class="built_in">dirtySlotsCache</span>(m.Id)</span><br><span class="line">        <span class="comment">// 更改状态</span></span><br><span class="line">		m.Action.State = models.ActionPending</span><br><span class="line">		m.Action.Index = ctx.<span class="built_in">maxSlotActionIndex</span>() + <span class="number">1</span></span><br><span class="line">		m.Action.TargetId = g.Id</span><br><span class="line">        <span class="comment">// 更改 etcd 状态</span></span><br><span class="line">		<span class="keyword">if</span> err := s.<span class="built_in">storeUpdateSlotMapping</span>(m); err != nil &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里会先检查一些状态，如果该 Slot 是否正在迁移，目标 Group 和 当前 Group 是否一致，然后将状态改为 <code>ActionPending</code>，然后保存到 Etcd 中就返回给用户了，在 Dashboard 启动的时候，有个协程会随着它启动，这个入口为 <code>Topom::ProcessSlotAction</code>，用来扫描这个状态进行迁移：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> !s.IsClosed() &#123;</span><br><span class="line">		<span class="keyword">if</span> s.IsOnline() &#123;</span><br><span class="line">			<span class="keyword">if</span> err := s.ProcessSlotAction(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.WarnErrorf(err, <span class="string">&quot;process slot action failed&quot;</span>)</span><br><span class="line">				time.Sleep(time.Second * <span class="number">5</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		time.Sleep(time.Second)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>

<p>其中这个 <code>ProcessSlotAction()</code>代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Topom)</span></span> ProcessSlotAction() <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">for</span> s.IsOnline() &#123;</span><br><span class="line">		<span class="keyword">var</span> (</span><br><span class="line">			marks = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">bool</span>)</span><br><span class="line">			plans = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">bool</span>)</span><br><span class="line">		)</span><br><span class="line">		<span class="keyword">var</span> accept = <span class="function"><span class="keyword">func</span><span class="params">(m *models.SlotMapping)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> marks[m.GroupId] || marks[m.Action.TargetId] &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> plans[m.Id] &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">var</span> update = <span class="function"><span class="keyword">func</span><span class="params">(m *models.SlotMapping)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> m.GroupId != <span class="number">0</span> &#123;</span><br><span class="line">				marks[m.GroupId] = <span class="literal">true</span></span><br><span class="line">			&#125;</span><br><span class="line">			marks[m.Action.TargetId] = <span class="literal">true</span></span><br><span class="line">			plans[m.Id] = <span class="literal">true</span></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">var</span> parallel = math2.MaxInt(<span class="number">1</span>, s.config.MigrationParallelSlots)</span><br><span class="line">		<span class="keyword">for</span> parallel &gt; <span class="built_in">len</span>(plans) &#123; <span class="comment">//状态转移在这里完成</span></span><br><span class="line">			_, ok, err := s.SlotActionPrepareFilter(accept, update)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> !ok &#123;</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(plans) == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">var</span> fut sync2.Future</span><br><span class="line">		<span class="keyword">for</span> sid, _ := <span class="keyword">range</span> plans &#123;</span><br><span class="line">			fut.Add()</span><br><span class="line">			<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(sid <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">				log.Warnf(<span class="string">&quot;slot-[%d] process action&quot;</span>, sid) </span><br><span class="line">                <span class="comment">//重点，真正的数据迁移</span></span><br><span class="line">				<span class="keyword">var</span> err = s.processSlotAction(sid)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					status := fmt.Sprintf(<span class="string">&quot;[ERROR] Slot[%04d]: %s&quot;</span>, sid, err)</span><br><span class="line">					s.action.progress.status.Store(status)</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					s.action.progress.status.Store(<span class="string">&quot;&quot;</span>)</span><br><span class="line">				&#125;</span><br><span class="line">				fut.Done(strconv.Itoa(sid), err)</span><br><span class="line">			&#125;(sid)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> _, v := <span class="keyword">range</span> fut.Wait() &#123;</span><br><span class="line">			<span class="keyword">if</span> v != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> v.(<span class="type">error</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		time.Sleep(time.Millisecond * <span class="number">10</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整体的状态变换过程如下：</p>
<p>ActionPending -&gt; ActionPreparing -&gt; ActionPrepared -&gt; ActionMigrating -&gt; ActionFinished</p>
<p>在 ActionMigrating 之前变更都只是更新 Etcd 中的状态，ActionPreparing 和 ActionPrepared 还会调用 resyncSlotMappings 通过Proxy 重连新的 Pika Server 并且设置 slot 从哪迁移等信息，我们看下实际的数据迁移是怎么发生的</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Topom)</span></span> processSlotAction(sid <span class="type">int</span>) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> db <span class="type">int</span> = <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> s.IsOnline() &#123;</span><br><span class="line">		<span class="keyword">if</span> exec, err := s.newSlotActionExecutor(sid); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> exec == <span class="literal">nil</span> &#123;</span><br><span class="line">			time.Sleep(time.Second)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			n, nextdb, err := exec(db)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">			log.Debugf(<span class="string">&quot;slot-[%d] action executor %d&quot;</span>, sid, n)</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> n == <span class="number">0</span> &amp;&amp; nextdb == <span class="number">-1</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> s.SlotActionComplete(sid)</span><br><span class="line">			&#125;</span><br><span class="line">			status := fmt.Sprintf(<span class="string">&quot;[OK] Slot[%04d]@DB[%d]=%d&quot;</span>, sid, db, n)</span><br><span class="line">			s.action.progress.status.Store(status)</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> us := s.GetSlotActionInterval(); us != <span class="number">0</span> &#123;</span><br><span class="line">				time.Sleep(time.Microsecond * time.Duration(us))</span><br><span class="line">			&#125;</span><br><span class="line">			db = nextdb</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 newSlotActionExecutor 得到执行器</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> models.ForwardSync: <span class="comment">// 同步</span></span><br><span class="line">	do = <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">int</span>, <span class="type">error</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> c.MigrateSlot(sid, dest)</span><br><span class="line">	&#125;</span><br><span class="line"><span class="keyword">case</span> models.ForwardSemiAsync: <span class="comment">// 异步</span></span><br><span class="line">	<span class="keyword">var</span> option = &amp;redis.MigrateSlotAsyncOption&#123;</span><br><span class="line">		MaxBulks: s.config.MigrationAsyncMaxBulks,</span><br><span class="line">		MaxBytes: s.config.MigrationAsyncMaxBytes.AsInt(),</span><br><span class="line">		NumKeys:  s.config.MigrationAsyncNumKeys,</span><br><span class="line">		Timeout: math2.MinDuration(time.Second*<span class="number">5</span>,</span><br><span class="line">			s.config.MigrationTimeout.Duration()),</span><br><span class="line">	&#125;</span><br><span class="line">	do = <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">int</span>, <span class="type">error</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> c.MigrateSlotAsync(sid, dest, option)</span><br><span class="line">	&#125;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">	log.Panicf(<span class="string">&quot;unknown forward method %d&quot;</span>, <span class="type">int</span>(method))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们先看下同步，这里调用的就是 <code>SLOTSMGRTTAGSLOT</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Client)</span></span> MigrateSlot(slot <span class="type">int</span>, target <span class="type">string</span>) (<span class="type">int</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	host, port, err := net.SplitHostPort(target)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, errors.Trace(err)</span><br><span class="line">	&#125;</span><br><span class="line">	mseconds := <span class="type">int</span>(c.Timeout / time.Millisecond)</span><br><span class="line">	<span class="keyword">if</span> reply, err := c.Do(<span class="string">&quot;SLOTSMGRTTAGSLOT&quot;</span>, host, port, mseconds, slot); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, errors.Trace(err)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		p, err := redigo.Ints(redigo.Values(reply, <span class="literal">nil</span>))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> || <span class="built_in">len</span>(p) != <span class="number">2</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>, errors.Errorf(<span class="string">&quot;invalid response = %v&quot;</span>, reply)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> p[<span class="number">1</span>], <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再看下异步，这里调用的是<code>SLOTSMGRTTAGSLOT-ASYNC</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Client)</span></span> MigrateSlotAsync(slot <span class="type">int</span>, target <span class="type">string</span>, option *MigrateSlotAsyncOption) (<span class="type">int</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	host, port, err := net.SplitHostPort(target)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, errors.Trace(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> reply, err := c.Do(<span class="string">&quot;SLOTSMGRTTAGSLOT-ASYNC&quot;</span>, host, port, <span class="type">int</span>(option.Timeout/time.Millisecond),</span><br><span class="line">		option.MaxBulks, option.MaxBytes, slot, option.NumKeys); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, errors.Trace(err)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		p, err := redigo.Ints(redigo.Values(reply, <span class="literal">nil</span>))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> || <span class="built_in">len</span>(p) != <span class="number">2</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>, errors.Errorf(<span class="string">&quot;invalid response = %v&quot;</span>, reply)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> p[<span class="number">1</span>], <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Pika-代码"><a href="#Pika-代码" class="headerlink" title="Pika 代码"></a>Pika 代码</h3><h4 id="Slot-生成"><a href="#Slot-生成" class="headerlink" title="Slot 生成"></a>Slot 生成</h4><p>在通过对代码的阅读后，我认为这里的 slot 代表的是一个 set 类型的数据结构，在这个 set 里面存放了我们的很多数据，slot 表示的是一个抽象的概念，接下来我们以一个 set 命令来讲解一下 slot 是什么<br><img width="905" alt="截屏2023-12-04 19 54 45" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/2121d8d9-6b0b-452c-8243-db436d29c540"></p>
<p>这里我们调用 <code>AddSlotKey</code> 函数生成这个 slot<br><img width="904" alt="截屏2023-12-04 19 55 00" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/daba04af-8634-4966-b7aa-1d10d6e5a799"></p>
<p>这里我们可以看到调用了 <code>SAdd</code> 命令将一个 slot 创建了，下面是我们在 <code>slotmigrate</code> 为 yes 的情况下，执行 <code>set key value</code> 命令可以看到的，图中我们执行 <code>keys * </code> 可以看到不仅仅有一个 key， 还有一个 <code>_internal:slotkey:4migrate:937</code> , 这个 937 就是我们计算出来的这个 key 的 hash 值。我们再看下这个 slot 下存放的数据可以看到有 <code>kkey</code>, 所以在 <code>slotmigrate</code> 打开的状态下，Pika 是存了两份数据的。</p>
<img width="906" alt="截屏2023-12-04 19 55 10" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/155baf02-e0f5-4b23-a94d-ac36d32a3cce">



<h4 id="Slot-迁移"><a href="#Slot-迁移" class="headerlink" title="Slot 迁移"></a>Slot 迁移</h4><ol>
<li><p>我们先看第一种 <code>SLOTSMGRTTAGSLOT</code> 同步迁移</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; slotsmgrttagslot host port <span class="built_in">timeout</span> slot</span><br><span class="line">&gt; slotsmgrttagslot 127.0.0.1 6380 100 579</span><br></pre></td></tr></table></figure>
<img width="897" alt="截屏2023-12-04 19 55 22" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/a751e969-c709-45d0-a407-344b28baab09"></li>
</ol>
<img width="905" alt="截屏2023-12-04 19 55 33" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/e58781c1-02e7-4b22-9d36-10a9defdf309">


<img width="899" alt="截屏2023-12-04 19 55 43" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/421984d9-eb25-48c0-8758-2abcff2ead51">
<img width="901" alt="截屏2023-12-04 19 56 21" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/f4e5c12b-423c-4feb-89d9-3b0befa71d8a">

<p>我们会先调用 <code>CleanMigrateClient()</code>函数把 Pika 超时之前把 <code>migrate_clients</code> 关闭，然后调用 <code>SlotsMgrtTag</code> 去迁移这个 Key，我们可以看到迁移的 Key 是通过 SSCAN 命令返回<br><img width="900" alt="截屏2023-12-04 19 56 36" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/01327a27-86f7-4558-8c69-7a17d1659199"><br>的，下面是迁移的具体逻辑：</p>
<p>我们可以看到迁移分为两个部分，第一部分就是迁移到目标机器上，另一部分就是删除本地的数据，我们这里重点看迁移的那个步骤<br><img width="894" alt="截屏2023-12-04 19 57 12" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/e1354403-28df-4382-a218-20df908daf12"></p>
<p>迁移分为三步：</p>
<ol>
<li>GetMigrateClient 建立 Redis 连接</li>
<li>MigrateSent 发送数据 (以命令的形式发送给目标机)</li>
<li>MigrateRecv 收到返回值</li>
</ol>
<p>总结一下，同步迁移整体的流程如下：</p>
<ol>
<li><p>CleanMigrateClient 清除超时连接</p>
</li>
<li><p>SlotsMgrtTag </p>
</li>
<li><p>SlotsMgrtOne</p>
</li>
<li><p>MigrateKey </p>
</li>
<li><p>GetMigrateClient 获取连接</p>
</li>
<li><p>MigrateSend 发送命令</p>
</li>
<li><p>MigrateRecv 接收返回值</p>
</li>
<li><p>第二种异步迁移 <code>SLOTSMGRTTAGSLOT-ASYNC</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; slotsmgrttagslot-async hostport <span class="built_in">timeout</span> maxbulks maxbytes slot numkeys</span><br><span class="line">&gt; slotsmgrttagslot-async pika 9221 5000 200 33554432 518 500</span><br></pre></td></tr></table></figure>

<p>​</p>
<img width="846" alt="截屏2023-12-04 19 57 28" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/084751d8-b1bd-4de3-b468-81c990cabc9f"></li>
</ol>
<img width="850" alt="截屏2023-12-04 19 57 54" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/e34e4597-a3ce-4281-8075-46f949685e84">
<img width="851" alt="截屏2023-12-04 19 58 06" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/1b92c474-0c4c-400e-a278-5b3b14a97a73">


<p>   ​</p>
<p>   这里的入口函数是 <code>SlotsMigrateBatch</code> , 最终调用的是 <code>ReqMigrateBatch</code>, 我们仔细看下这个函数：</p>
<img width="856" alt="截屏2023-12-04 19 58 21" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/b0c515d7-6786-4789-9988-1d53ae0447eb">


<p>   这里的 <code>StartThread</code>就是执行 <code>PikaMigrateThread</code> 的 <code>ThreadMain</code>，这个 <code>CreateParseSendThreads</code> 的逻辑我们看下<br><img width="857" alt="截屏2023-12-04 19 58 59" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/d866fe21-4697-43f2-b0d1-f617d043121a"></p>
<p>   可以看到 <code>CreateParseSendThreads</code>函数中，又启动了新的线程 <code>worker-&gt;StartThread()</code>,这里的 worker 类型是 <code>PikaParseSendThread</code> 类型，这里的 <code>StartThread</code>的入口函数就是 <code>PikaParseSendThread</code>的 <code>ThreadMain</code>函数<br><img width="848" alt="截屏2023-12-04 19 59 14" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/16812d6d-3d36-424f-a796-6b859148a600"></p>
<p>   真正的迁移操作就在这个 <code>MigrateOneKey</code>中</p>
<img width="863" alt="截屏2023-12-04 19 59 24" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/49f9135a-ba7e-4224-9bd3-790315848450">


<p>   这里面的逻辑我就不多介绍，大致的意思还是和同步的逻辑一样，建立连接然后调用 <code>cli-&gt;Send</code>发送命令</p>
<img width="852" alt="截屏2023-12-04 19 59 41" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/ac261b6e-8b1c-4a75-9a42-90db5889f6e8">

<img width="851" alt="截屏2023-12-04 20 00 03" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/f7765b00-9b1d-4473-8ae4-8a7f2384ba7f">




<p>总结一下在异步同步过程中，调用了 <code>SlotsMigrateBatch</code>接口，然后启动了 <code>PikaMigrateThread</code>去做迁移 key 的操作，在 <code>PikaMigrateThread</code>中又启动了一组 <code>PikaParseSendThread</code>的 worker 线程去做真正的迁移操作，通过建立连接，向目标机发送命令的形式传递 slot 中的 key</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/10/10/Pika%E7%9A%84slot%E8%BF%81%E7%A7%BB%E5%AD%A6%E4%B9%A0/" data-id="clpqxevc1000z1trf5u7d3llc" data-title="Pika的slot数据迁移学习" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Blog/" rel="tag">Blog</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/10/26/Pika%E7%9A%84Cache%E6%96%B9%E6%A1%88/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Pika的Cache方案
        
      </div>
    </a>
  
  
    <a href="/2023/09/25/Pika%E5%8A%A8%E6%80%81%E5%85%B3%E9%97%ADWAL%E6%96%B9%E6%A1%88/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Pika动态关闭WAL方案</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Blog/" rel="tag">Blog</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Blog/" style="font-size: 10px;">Blog</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">October 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">August 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/11/30/Floyd%E5%A4%9Akey%E5%91%BD%E4%BB%A4%E5%9C%A8%E5%B9%B6%E5%8F%91%E5%9C%BA%E6%99%AF%E4%B8%8B%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/">Floyd的多key命令在并发场景下的解决方案</a>
          </li>
        
          <li>
            <a href="/2023/11/27/Floyd%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88%E8%A7%A3%E6%9E%90/">Pika的Floyd设计方案</a>
          </li>
        
          <li>
            <a href="/2023/11/21/Pika%E5%9C%A8K8s%E4%B8%8A%E7%9A%84%E6%89%A9%E5%AE%B9/">Pika在K8s上的扩容</a>
          </li>
        
          <li>
            <a href="/2023/10/30/Pika%E7%9A%84CacheStatus%E6%96%B9%E6%A1%88/">Pika的CacheStatus方案</a>
          </li>
        
          <li>
            <a href="/2023/10/26/Pika%E7%9A%84Cache%E6%96%B9%E6%A1%88/">Pika的Cache方案</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>