<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Pika的全量同步源码剖析 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="背景本篇介绍一下 Pika 的全量同步">
<meta property="og:type" content="article">
<meta property="og:title" content="Pika的全量同步源码剖析">
<meta property="og:url" content="http://example.com/2024/01/09/Pika%E7%9A%84%E5%85%A8%E9%87%8F%E5%90%8C%E6%AD%A5/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="背景本篇介绍一下 Pika 的全量同步">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/b1b4cad4-fa8a-4614-8d24-baeaaef01287">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/bbc330ff-2c84-4e1a-9004-a6cd96a3fedc">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/d4d5d1ba-8796-4149-a991-d8eff6cbe299">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/49e9778c-b48e-43ef-a4f2-b4764d223aaf">
<meta property="og:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/bf381574-4175-4b02-a948-a6d2c442667f">
<meta property="article:published_time" content="2024-01-09T09:03:43.333Z">
<meta property="article:modified_time" content="2024-01-25T02:13:56.917Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/OpenAtomFoundation/pika/assets/73943232/b1b4cad4-fa8a-4614-8d24-baeaaef01287">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-Pika的全量同步" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/09/Pika%E7%9A%84%E5%85%A8%E9%87%8F%E5%90%8C%E6%AD%A5/" class="article-date">
  <time class="dt-published" datetime="2024-01-09T09:03:43.333Z" itemprop="datePublished">2024-01-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Pika的全量同步源码剖析
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>本篇介绍一下 Pika 的全量同步<span id="more"></span>，在讲解代码之前我先介绍一下主从同步中涉及到的几种状态(状态机)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// role 角色</span></span><br><span class="line">PIKA_ROLE_SINGLE = <span class="number">0</span> (初始节点)</span><br><span class="line">PIKA_ROLE_SLAVE = <span class="number">1</span> (从节点)</span><br><span class="line">PIKA_ROLE_MASTER = <span class="number">2</span> (主节点)</span><br><span class="line">  </span><br><span class="line"><span class="comment">// repl_state_</span></span><br><span class="line">PIKA_REPL_NO_CONNECT = <span class="number">0</span> (未连接状态)</span><br><span class="line">PIKA_REPL_SHOULD_META_SYNC = <span class="number">1</span> (Meta_Sync状态)</span><br><span class="line">PIKA_REPL_META_SYNC_DONE = <span class="number">2</span> (Meta_Sync_Done状态)</span><br><span class="line">PIKA_REPL_ERROR = <span class="number">3</span> (Error状态)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">enum</span> ReplState &#123;</span><br><span class="line">  kNoConnect = <span class="number">0</span>,  </span><br><span class="line">  kTryConnect = <span class="number">1</span>, </span><br><span class="line">  kTryDBSync = <span class="number">2</span>,</span><br><span class="line">  kWaitDBSync = <span class="number">3</span>,</span><br><span class="line">  kWaitReply = <span class="number">4</span>,</span><br><span class="line">  kConnected = <span class="number">5</span>,</span><br><span class="line">  kError = <span class="number">6</span>,</span><br><span class="line">  kDBNoConnect = <span class="number">7</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="1-从命令开始"><a href="#1-从命令开始" class="headerlink" title="1. 从命令开始"></a>1. 从命令开始</h2><p>**src&#x2F;pika_admin.cc **</p>
<p>我们调用 <code>slaveof ip port</code> 会进行主从同步操作，首先会调用 <code>RemoveMaster</code> 移除当前节点的主节点，，然后调用 <code>SetMaster</code> 设置新的 <code>Master</code> 节点. </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">SlaveofCmd::Do</span><span class="params">(std::shared_ptr&lt;Slot&gt; slot)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  g_pika_server-&gt;<span class="built_in">RemoveMaster</span>();</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> sm_ret = g_pika_server-&gt;<span class="built_in">SetMaster</span>(master_ip_, <span class="built_in">static_cast</span>&lt;<span class="type">int32_t</span>&gt;(master_port_));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (sm_ret) &#123;</span><br><span class="line">    res_.<span class="built_in">SetRes</span>(CmdRes::kOk);</span><br><span class="line">    g_pika_server-&gt;<span class="built_in">ClearCacheDbAsync</span>(slot);</span><br><span class="line">    g_pika_conf-&gt;<span class="built_in">SetSlaveof</span>(master_ip_ + <span class="string">&quot;:&quot;</span> + std::<span class="built_in">to_string</span>(master_port_));</span><br><span class="line">    g_pika_conf-&gt;<span class="built_in">SetMasterRunID</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    g_pika_server-&gt;<span class="built_in">SetFirstMetaSync</span>(<span class="literal">true</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res_.<span class="built_in">SetRes</span>(CmdRes::kErrOther, <span class="string">&quot;Server is not in correct state for slaveof&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>src&#x2F;pika_server.cc</strong></p>
<p>在这里将 <code>repl_state</code> 状态置为 <code>PIKA_REPL_NO_CONNECT</code>，  <code>master_ip</code> , <code>master_port</code> 都进行了初始化，如果之前这个节点有主节点的话调用 <code>CloseReplClientConn</code> 和 <code>LostConnection</code> 分别关闭 <code>PikaReplClient</code> 连接和 <code>RsyncClient</code> 连接，最后调用 <code>DoSameThingEvertSlot</code> 将所有的 <code>syncslaveslot</code> 的状态置为 <code>kNoConnect</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PikaServer::RemoveMaster</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function">std::lock_guard <span class="title">l</span><span class="params">(state_protector_)</span></span>;</span><br><span class="line">    repl_state_ = PIKA_REPL_NO_CONNECT;</span><br><span class="line">    role_ &amp;= ~PIKA_ROLE_SLAVE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!master_ip_.<span class="built_in">empty</span>() &amp;&amp; master_port_ != <span class="number">-1</span>) &#123;</span><br><span class="line">      g_pika_rm-&gt;<span class="built_in">CloseReplClientConn</span>(master_ip_, master_port_ + kPortShiftReplServer);</span><br><span class="line">      g_pika_rm-&gt;<span class="built_in">LostConnection</span>(master_ip_, master_port_);</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    master_ip_ = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    master_port_ = <span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">DoSameThingEverySlot</span>(TaskType::kResetReplState);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>src&#x2F;pika_rm.cc</strong></p>
<p>关闭 <code>RepClientConn</code> 连接</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">PikaReplicaManager::CloseReplClientConn</span><span class="params">(<span class="type">const</span> std::string&amp; ip, <span class="type">int32_t</span> port)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> pika_repl_client_-&gt;<span class="built_in">Close</span>(ip, port);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>src&#x2F;pika_rm.cc</strong></p>
<p>这里将 <code>sync_master_slots</code> 中的 <code>slaves_</code> 移除，将 <code>sync_slave_slots</code> 中的 <code>rsync_cli_</code> 停止</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">PikaReplicaManager::LostConnection</span><span class="params">(<span class="type">const</span> std::string&amp; ip, <span class="type">int</span> port)</span> </span>&#123;</span><br><span class="line">  <span class="function">std::shared_lock <span class="title">l</span><span class="params">(slots_rw_)</span></span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; iter : sync_master_slots_) &#123;</span><br><span class="line">    std::shared_ptr&lt;SyncMasterSlot&gt; slot = iter.second;</span><br><span class="line">    Status s = slot-&gt;<span class="built_in">RemoveSlaveNode</span>(ip, port);</span><br><span class="line">    <span class="keyword">if</span> (!s.<span class="built_in">ok</span>() &amp;&amp; !s.<span class="built_in">IsNotFound</span>()) &#123;</span><br><span class="line">      <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Lost Connection failed &quot;</span> &lt;&lt; s.<span class="built_in">ToString</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; iter : sync_slave_slots_) &#123;</span><br><span class="line">    std::shared_ptr&lt;SyncSlaveSlot&gt; slot = iter.second;</span><br><span class="line">    <span class="keyword">if</span> (slot-&gt;<span class="built_in">MasterIp</span>() == ip &amp;&amp; slot-&gt;<span class="built_in">MasterPort</span>() == port) &#123;</span><br><span class="line">      slot-&gt;<span class="built_in">Deactivate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><ul>
<li><p>为什么这里 role 的状态转移用的是 <code>role_ &amp;= ~PIKA_ROLE_SLAVE;</code> 不能直接用 <code>role_ = PIKA_ROLE_SLAVE</code></p>
<p>​</p>
</li>
</ul>
<p><strong>src&#x2F;pika_admin.cc</strong></p>
<p>这里将 <code>repl_state_</code> 设置为 <code>PIKA_REPL_SHOULD_META_SYNC</code> 标识</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">PikaServer::SetMaster</span><span class="params">(std::string&amp; master_ip, <span class="type">int</span> master_port)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (master_ip == <span class="string">&quot;127.0.0.1&quot;</span>) &#123;</span><br><span class="line">    master_ip = host_;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function">std::lock_guard <span class="title">l</span><span class="params">(state_protector_)</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (((role_ ^ PIKA_ROLE_SLAVE) != <span class="number">0</span>) &amp;&amp; repl_state_ == PIKA_REPL_NO_CONNECT) &#123;</span><br><span class="line">    master_ip_ = master_ip;</span><br><span class="line">    master_port_ = master_port;</span><br><span class="line">    role_ |= PIKA_ROLE_SLAVE;</span><br><span class="line">    repl_state_ = PIKA_REPL_SHOULD_META_SYNC;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="FAQ-1"><a href="#FAQ-1" class="headerlink" title="FAQ"></a>FAQ</h2><ul>
<li><p><code>PikaReplClient</code> 连接和 <code>RsyncClient</code> 连接有什么区别</p>
<p><code>PikaReplClient</code> 是端口号 + 2000 偏移量，<code>RsyncClient</code> 是端口号 + 1000 偏移量, <code>CloseReplClientConn</code> 关闭了 <code>ReplClient</code> 连接，<code>LostConnection</code> 关闭了 <code>Rsync</code> 连接</p>
</li>
<li><p>为什么要用 <code>((role_ ^ PIKA_ROLE_SLAVE) != 0)</code> 不能直接用 <code>role_ == PIKA_ROLE_SINGLE</code>, <code>role |= PIKA_ROLE_SLAVE</code> 为什么不能用 <code>role = PIKA_ROLE_SLAVE</code></p>
<p>​</p>
<p>​</p>
</li>
</ul>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>在 <code>slaveof</code> 命令中将 <code>repl_state_</code> 设置为 <code>PIKA_REPL_SHOULD_META_SYNC</code> ,每个 <code>syncslaveslot</code> 状态置为了 <code>kNoConnect</code>, <code>role_</code> 设置成了 <code>PIKA_ROLE_SLAVE</code> , <code>first_meta_sync_</code> 设置成了 <code>true</code> </p>
<h2 id="2-MetaSync"><a href="#2-MetaSync" class="headerlink" title="2. MetaSync"></a>2. MetaSync</h2><p><strong>src&#x2F;pika_auxiliary_thread.cc</strong></p>
<p>在刚刚的 <code>slaveof</code>命令执行完毕时，<code>repl_state_</code> 被置为了 <code>PIKA_REPL_SHOULD_META_SYNC</code> 了，所以这里经过了 <code>ShouldMetaSync</code> 判断后会调用 <code>SendMetaSyncRequest</code> 发起 <code>MetaSync</code> 请求</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="title">PikaAuxiliaryThread::ThreadMain</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (!<span class="built_in">should_stop</span>()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (g_pika_server-&gt;<span class="built_in">ShouldMetaSync</span>()) &#123;</span><br><span class="line">      g_pika_rm-&gt;<span class="built_in">SendMetaSyncRequest</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (g_pika_server-&gt;<span class="built_in">MetaSyncDone</span>()) &#123;</span><br><span class="line">      g_pika_rm-&gt;<span class="built_in">RunSyncSlaveSlotStateMachine</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>src&#x2F;pika_server.cc</strong></p>
<p>判断 <code>repl_state_</code> 是不是需要 <code>META_SYNC</code> 状态</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">PikaServer::ShouldMetaSync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="function">std::shared_lock <span class="title">l</span><span class="params">(state_protector_)</span></span>;</span><br><span class="line">  <span class="keyword">return</span> repl_state_ == PIKA_REPL_SHOULD_META_SYNC;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>src&#x2F;pika_rm.cc</strong></p>
<p>这里调用 <code>SendMetaSync</code>，同时在请求发送成功后，更新 <code>MetaSync</code>的 <code>Timestamp</code> 以及将 <code>FirstsetMetaSync</code> 置为 <code>false</code> .</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">PikaReplicaManager::SendMetaSyncRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Status s;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">time</span>(<span class="literal">nullptr</span>) - g_pika_server-&gt;<span class="built_in">GetMetaSyncTimestamp</span>() &gt;= PIKA_META_SYNC_MAX_WAIT_TIME ||</span><br><span class="line">      g_pika_server-&gt;<span class="built_in">IsFirstMetaSync</span>()) &#123;</span><br><span class="line">    s = pika_repl_client_-&gt;<span class="built_in">SendMetaSync</span>();</span><br><span class="line">    <span class="keyword">if</span> (s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">      g_pika_server-&gt;<span class="built_in">UpdateMetaSyncTimestamp</span>();</span><br><span class="line">      g_pika_server-&gt;<span class="built_in">SetFirstMetaSync</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="FAQ-2"><a href="#FAQ-2" class="headerlink" title="FAQ"></a>FAQ</h2><ul>
<li><code>time(nullptr) - g_pika_server-&gt;GetMetaSyncTimestamp() &gt;= PIKA_META_SYNC_MAX_WAIT_TIME</code> 为什么需要这一层判断</li>
</ul>
<p><strong>src&#x2F;pika_repl_client.cc</strong></p>
<p>这里可以看到主从全量复制的时候，都是从发起的连接，而主复用这条连接给从返回，这里先新建一个连接尝试连远端的 <code>master-ip</code>看是否能连接成功，并获取到 <code>local-ip</code>, 使用 <code>InnerMessage</code> 将 <code>type</code> 置为 <code>kMetaSync</code> 然后传入 <code>ip</code>, <code>port</code> 随后发送给 <code>Master</code>，发送给 <code>Master</code> 目标端口 + <code>2000</code> 的端口</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">PikaReplClient::SendMetaSync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  std::string local_ip;</span><br><span class="line">  <span class="function">std::unique_ptr&lt;net::NetCli&gt; <span class="title">cli</span> <span class="params">(net::NewRedisCli())</span></span>;</span><br><span class="line">  cli-&gt;<span class="built_in">set_connect_timeout</span>(<span class="number">1500</span>);</span><br><span class="line">  <span class="keyword">if</span> ((cli-&gt;<span class="built_in">Connect</span>(g_pika_server-&gt;<span class="built_in">master_ip</span>(), g_pika_server-&gt;<span class="built_in">master_port</span>(), <span class="string">&quot;&quot;</span>)).<span class="built_in">ok</span>()) &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> laddr;</span><br><span class="line">    <span class="type">socklen_t</span> llen = <span class="built_in">sizeof</span>(laddr);</span><br><span class="line">    <span class="built_in">getsockname</span>(cli-&gt;<span class="built_in">fd</span>(), <span class="built_in">reinterpret_cast</span>&lt;<span class="keyword">struct</span> sockaddr*&gt;(&amp;laddr), &amp;llen);</span><br><span class="line">    <span class="function">std::string <span class="title">tmp_local_ip</span><span class="params">(inet_ntoa(laddr.sin_addr))</span></span>;</span><br><span class="line">    local_ip = tmp_local_ip;</span><br><span class="line">    cli-&gt;<span class="built_in">Close</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Failed to connect master, Master (&quot;</span> &lt;&lt; g_pika_server-&gt;<span class="built_in">master_ip</span>() &lt;&lt; <span class="string">&quot;:&quot;</span></span><br><span class="line">                 &lt;&lt; g_pika_server-&gt;<span class="built_in">master_port</span>() &lt;&lt; <span class="string">&quot;), try reconnect&quot;</span>;</span><br><span class="line">    <span class="comment">// Sleep three seconds to avoid frequent try Meta Sync</span></span><br><span class="line">    <span class="comment">// when the connection fails</span></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">3</span>);</span><br><span class="line">    g_pika_server-&gt;<span class="built_in">ResetMetaSyncStatus</span>();</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">Corruption</span>(<span class="string">&quot;Connect master error&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  InnerMessage::InnerRequest request;</span><br><span class="line">  request.<span class="built_in">set_type</span>(InnerMessage::kMetaSync);</span><br><span class="line">  InnerMessage::InnerRequest::MetaSync* meta_sync = request.<span class="built_in">mutable_meta_sync</span>();</span><br><span class="line">  InnerMessage::Node* node = meta_sync-&gt;<span class="built_in">mutable_node</span>();</span><br><span class="line">  node-&gt;<span class="built_in">set_ip</span>(local_ip);</span><br><span class="line">  node-&gt;<span class="built_in">set_port</span>(g_pika_server-&gt;<span class="built_in">port</span>());</span><br><span class="line">  ...</span><br><span class="line">  std::string to_send;</span><br><span class="line">  std::string master_ip = g_pika_server-&gt;<span class="built_in">master_ip</span>();</span><br><span class="line">  <span class="type">int</span> master_port = g_pika_server-&gt;<span class="built_in">master_port</span>();</span><br><span class="line">  <span class="keyword">if</span> (!request.<span class="built_in">SerializeToString</span>(&amp;to_send)) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Serialize Meta Sync Request Failed, to Master (&quot;</span> &lt;&lt; master_ip &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; master_port &lt;&lt; <span class="string">&quot;)&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">Corruption</span>(<span class="string">&quot;Serialize Failed&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Try Send Meta Sync Request to Master (&quot;</span> &lt;&lt; master_ip &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; master_port &lt;&lt; <span class="string">&quot;)&quot;</span>;</span><br><span class="line">  <span class="keyword">return</span> client_thread_-&gt;<span class="built_in">Write</span>(master_ip, master_port + kPortShiftReplServer, to_send);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>小结</strong></p>
<p><code>MetaSync</code> 请求中从节点给主节点发送了自己的 <code>ip</code>, <code>port</code>, <code>masterauth</code> , 发送的端口号是主节点端口 + <code>2000</code></p>
<h2 id="FAQ-3"><a href="#FAQ-3" class="headerlink" title="FAQ"></a>FAQ</h2><ul>
<li><p>为什么连接失败要调用 <code>ResetMetaSyncStatus</code> 重置状态</p>
</li>
<li><p>怎么判断主从复制的连接是长连接，如果是的话是不是 <code>fd</code> 就不会改变了</p>
</li>
<li><p>为什么要获取 <code>local-ip</code></p>
<p>​</p>
</li>
</ul>
<p><strong>src&#x2F;pika_repl_server_conn.cc</strong></p>
<p>Master 节点拿到 <code>InnerMessage</code> 后，对比一下 <code>masterauth</code> ，然后调用 <code>TryAddSlave</code> 在 <code>Pika_server</code> 中的 <code>slaves_</code>中添加 <code>slave</code> 节点信息，然后调用 <code>ReplServerUpdateClientConnMap </code>往 <code>Pika_server</code> 中的 <code>client_conn_map</code> 中添加节点信息，调用 <code>BecomeMaster</code> 把自己的角色从 <code>PIKA_ROLE_SINGLE</code> 变为 <code>PIKA_ROLE_MASTER</code> ，将返回码状态置为 <code>kOK</code> ，这时候主节点产生 <code>ReplicationID</code>, 然后在 <code>InnerMessage</code> 中记录了 <code>classic_mode</code> , <code>run_id</code> , <code>replication_id</code>, 以及 <code>db_struct</code> 写回给从节点</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PikaReplServerConn::HandleMetaSyncRequest</span><span class="params">(<span class="type">void</span>* arg)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">    <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Receive MetaSync, Slave ip: &quot;</span> &lt;&lt; node.<span class="built_in">ip</span>() &lt;&lt; <span class="string">&quot;, Slave port:&quot;</span> &lt;&lt; node.<span class="built_in">port</span>();</span><br><span class="line">    std::vector&lt;DBStruct&gt; db_structs = g_pika_conf-&gt;<span class="built_in">db_structs</span>();</span><br><span class="line">    <span class="type">bool</span> success = g_pika_server-&gt;<span class="built_in">TryAddSlave</span>(node.<span class="built_in">ip</span>(), node.<span class="built_in">port</span>(), conn-&gt;<span class="built_in">fd</span>(), db_structs);</span><br><span class="line">    <span class="type">const</span> std::string ip_port = pstd::<span class="built_in">IpPortString</span>(node.<span class="built_in">ip</span>(), node.<span class="built_in">port</span>());</span><br><span class="line">    g_pika_rm-&gt;<span class="built_in">ReplServerUpdateClientConnMap</span>(ip_port, conn-&gt;<span class="built_in">fd</span>());</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">      response.<span class="built_in">set_code</span>(InnerMessage::kOther);</span><br><span class="line">      response.<span class="built_in">set_reply</span>(<span class="string">&quot;Slave AlreadyExist&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      g_pika_server-&gt;<span class="built_in">BecomeMaster</span>();</span><br><span class="line">      response.<span class="built_in">set_code</span>(InnerMessage::kOk);</span><br><span class="line">      InnerMessage::InnerResponse_MetaSync* meta_sync = response.<span class="built_in">mutable_meta_sync</span>();</span><br><span class="line">      <span class="keyword">if</span> (g_pika_conf-&gt;<span class="built_in">replication_id</span>() == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">        std::string replication_id = pstd::<span class="built_in">getRandomHexChars</span>(configReplicationIDSize);</span><br><span class="line">        g_pika_conf-&gt;<span class="built_in">SetReplicationID</span>(replication_id);</span><br><span class="line">        g_pika_conf-&gt;<span class="built_in">ConfigRewriteReplicationID</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      meta_sync-&gt;<span class="built_in">set_classic_mode</span>(g_pika_conf-&gt;<span class="built_in">classic_mode</span>());</span><br><span class="line">      meta_sync-&gt;<span class="built_in">set_run_id</span>(g_pika_conf-&gt;<span class="built_in">run_id</span>());</span><br><span class="line">      meta_sync-&gt;<span class="built_in">set_replication_id</span>(g_pika_conf-&gt;<span class="built_in">replication_id</span>());</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; db_struct : db_structs) &#123;</span><br><span class="line">        InnerMessage::InnerResponse_MetaSync_DBInfo* db_info = meta_sync-&gt;<span class="built_in">add_dbs_info</span>();</span><br><span class="line">        db_info-&gt;<span class="built_in">set_db_name</span>(db_struct.db_name);</span><br><span class="line">        db_info-&gt;<span class="built_in">set_slot_num</span>(<span class="built_in">static_cast</span>&lt;<span class="type">int32_t</span>&gt;(db_struct.slot_num));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  std::string reply_str;</span><br><span class="line">  <span class="keyword">if</span> (!response.<span class="built_in">SerializeToString</span>(&amp;reply_str) || (conn-&gt;<span class="built_in">WriteResp</span>(reply_str) != <span class="number">0</span>)) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Process MetaSync request serialization failed&quot;</span>;</span><br><span class="line">    conn-&gt;<span class="built_in">NotifyClose</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  conn-&gt;<span class="built_in">NotifyWrite</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="MetaSync-总结"><a href="#MetaSync-总结" class="headerlink" title="MetaSync 总结"></a>MetaSync 总结</h3><p>在 <code>MetaSync</code> 请求中，主节点给从节点回了 <code>classic_mode</code> , <code>run_id</code>, <code>replication_id</code>,<code>db_name</code>, <code>slot_num</code> 这些信息，用于从节点去对比自己的 DB 结构以及设置 <code>replication_id</code>.</p>
<img width="782" alt="截屏2024-01-25 10 10 52" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/b1b4cad4-fa8a-4614-8d24-baeaaef01287">

<p><strong>src&#x2F;pika_repl_client_conn.cc</strong></p>
<p>从节点拿到 Master 的 <code>MetaSyncResponse</code>，先解析状态码，如果是 <code>kOther</code> 则重新进行 <code>MetaSync</code>，如果不是 <code>kOK</code> 则报错，将 <code>repl_state_</code> 置为 <code>PIKA_REPL_ERROR</code>, 如果顺利的话就从 Master 节点返回的 DBStruct 去对比自己的 DBStruct (这里对比的是 DBName, slot_sum, slot_id 这些值)，如果不一致则将 <code>repl_state_</code> 置为 <code>PIKA_REPL_ERROR</code> 代表不能做主从同步, 如果和 Master 的 DB 结构一样的话，去查看 Master 返回的 <code>ReplicationID</code> , 如果传过来为空则等待下次请求，如果不为空，判断从节点自己原来有没有 <code>ReplicationID</code> ，如果没有，则将主节点的设置成从节点自己的 <code>ReplicationID</code>，同时将 <code>force_fulll_sync</code> 置为 <code>true</code>代表进行强制全量同步 ，然后调用 <code>PrepareSlotTrySync</code>, 以及调用 <code>FinishMetaSync</code> 将 <code>repl_state_</code> 状态置为 <code>PIKA_REPL_META_SYNC_DONE</code> 代表 <code>MetaSync</code> 流程完毕</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PikaReplClientConn::HandleMetaSyncResponse</span><span class="params">(<span class="type">void</span>* arg)</span> </span>&#123;</span><br><span class="line">  <span class="function">std::unique_ptr&lt;ReplClientTaskArg&gt; <span class="title">task_arg</span><span class="params">(<span class="keyword">static_cast</span>&lt;ReplClientTaskArg*&gt;(arg))</span></span>;</span><br><span class="line">  std::shared_ptr&lt;net::PbConn&gt; conn = task_arg-&gt;conn;</span><br><span class="line">  std::shared_ptr&lt;InnerMessage::InnerResponse&gt; response = task_arg-&gt;res;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> InnerMessage::InnerResponse_MetaSync meta_sync = response-&gt;<span class="built_in">meta_sync</span>();</span><br><span class="line"></span><br><span class="line">  std::vector&lt;DBStruct&gt; master_db_structs;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> idx = <span class="number">0</span>; idx &lt; meta_sync.<span class="built_in">dbs_info_size</span>(); ++idx) &#123;</span><br><span class="line">    <span class="type">const</span> InnerMessage::InnerResponse_MetaSync_DBInfo&amp; db_info = meta_sync.<span class="built_in">dbs_info</span>(idx);</span><br><span class="line">    master_db_structs.<span class="built_in">push_back</span>(&#123;db_info.<span class="built_in">db_name</span>(), <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(db_info.<span class="built_in">slot_num</span>()), &#123;<span class="number">0</span>&#125;&#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::vector&lt;DBStruct&gt; self_db_structs = g_pika_conf-&gt;<span class="built_in">db_structs</span>();</span><br><span class="line">  <span class="keyword">if</span> (!PikaReplClientConn::<span class="built_in">IsDBStructConsistent</span>(self_db_structs, master_db_structs)) &#123;</span><br><span class="line">    ...</span><br><span class="line">    g_pika_server-&gt;<span class="built_in">SyncError</span>();</span><br><span class="line">    conn-&gt;<span class="built_in">NotifyClose</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The relicationid obtained from the server is null</span></span><br><span class="line">  <span class="keyword">if</span> (meta_sync.<span class="built_in">replication_id</span>() == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Meta Sync Failed: the relicationid obtained from the server is null, keep sending MetaSync msg&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The Replicationids of both the primary and secondary Replicationid are not empty and are not equal</span></span><br><span class="line">  <span class="keyword">if</span> (g_pika_conf-&gt;<span class="built_in">replication_id</span>() != meta_sync.<span class="built_in">replication_id</span>() &amp;&amp; g_pika_conf-&gt;<span class="built_in">replication_id</span>() != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Meta Sync Failed: replicationid on both sides of the connection are inconsistent&quot;</span>;</span><br><span class="line">    g_pika_server-&gt;<span class="built_in">SyncError</span>();</span><br><span class="line">    conn-&gt;<span class="built_in">NotifyClose</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// First synchronization between the master and slave</span></span><br><span class="line">  <span class="keyword">if</span> (g_pika_conf-&gt;<span class="built_in">replication_id</span>() != meta_sync.<span class="built_in">replication_id</span>()) &#123;</span><br><span class="line">    ...</span><br><span class="line">    g_pika_server-&gt;force_full_sync_ = <span class="literal">true</span>;</span><br><span class="line">    g_pika_conf-&gt;<span class="built_in">SetReplicationID</span>(meta_sync.<span class="built_in">replication_id</span>());</span><br><span class="line">    g_pika_conf-&gt;<span class="built_in">ConfigRewriteReplicationID</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  g_pika_conf-&gt;<span class="built_in">SetWriteBinlog</span>(<span class="string">&quot;yes&quot;</span>);</span><br><span class="line">  g_pika_server-&gt;<span class="built_in">PrepareSlotTrySync</span>();</span><br><span class="line">  g_pika_server-&gt;<span class="built_in">FinishMetaSync</span>();</span><br><span class="line">  <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Finish to handle meta sync response&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="FAQ-4"><a href="#FAQ-4" class="headerlink" title="FAQ"></a>FAQ</h2><ul>
<li><p>主节点传递过来的 <code>run-id</code> 好像没有用到，是否可以进行删除</p>
<p>​</p>
</li>
</ul>
<p><strong>src&#x2F;pika_server.cc</strong></p>
<p>在 <code>PrepardSlotTrySync</code> 中判断 <code>force_full_sync_</code> 是不是要进行强制全量同步， 如果是的话将 <code>state</code> 置为 <code>kTryDBSync</code> 否则置为 <code>kTryConnect</code>, 遍历整个 DB 结构每一个 <code>slot </code>去调用 <code>ActicateSyncSlaveSlot</code> 去和 Master 节点做连接</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PikaServer::PrepareSlotTrySync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="function">std::shared_lock <span class="title">rwl</span><span class="params">(dbs_rw_)</span></span>;</span><br><span class="line">  ReplState state = force_full_sync_ ? ReplState::kTryDBSync : ReplState::kTryConnect;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; db_item : dbs_) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; slot_item : db_item.second-&gt;slots_) &#123;</span><br><span class="line">      Status s = g_pika_rm-&gt;<span class="built_in">ActivateSyncSlaveSlot</span>(</span><br><span class="line">          <span class="built_in">RmNode</span>(g_pika_server-&gt;<span class="built_in">master_ip</span>(), g_pika_server-&gt;<span class="built_in">master_port</span>(), db_item.second-&gt;<span class="built_in">GetDBName</span>(),</span><br><span class="line">                 slot_item.second-&gt;<span class="built_in">GetSlotID</span>()),</span><br><span class="line">          state);</span><br><span class="line">      <span class="keyword">if</span> (!s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">        <span class="built_in">LOG</span>(WARNING) &lt;&lt; s.<span class="built_in">ToString</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  force_full_sync_ = <span class="literal">false</span>;</span><br><span class="line">  <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Mark try connect finish&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>src&#x2F;pika_rm.cc</strong></p>
<p><code>SelectLocalIP</code> 让每个 <code>slot</code> 和远端的 Master 都尝试建立一条连接，然后将每个节点的 <code>state</code> 置为 <code>kTryDBSync</code> ，这里的 <code>sync_slave_slots</code> 保存了每个 <code>slot</code> 的信息</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">PikaReplicaManager::ActivateSyncSlaveSlot</span><span class="params">(<span class="type">const</span> RmNode&amp; node, <span class="type">const</span> ReplState&amp; repl_state)</span> </span>&#123;</span><br><span class="line">  <span class="function">std::shared_lock <span class="title">l</span><span class="params">(slots_rw_)</span></span>;</span><br><span class="line">  <span class="type">const</span> SlotInfo&amp; p_info = node.<span class="built_in">NodeSlotInfo</span>();</span><br><span class="line">  <span class="keyword">if</span> (sync_slave_slots_.<span class="built_in">find</span>(p_info) == sync_slave_slots_.<span class="built_in">end</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">NotFound</span>(<span class="string">&quot;Sync Slave Slot &quot;</span> + node.<span class="built_in">ToString</span>() + <span class="string">&quot; not found&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  ReplState ssp_state = sync_slave_slots_[p_info]-&gt;<span class="built_in">State</span>();</span><br><span class="line">  <span class="keyword">if</span> (ssp_state != ReplState::kNoConnect &amp;&amp; ssp_state != ReplState::kDBNoConnect) &#123;</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">Corruption</span>(<span class="string">&quot;Sync Slave Slot in &quot;</span> + ReplStateMsg[ssp_state]);</span><br><span class="line">  &#125;</span><br><span class="line">  std::string local_ip;</span><br><span class="line">  Status s = <span class="built_in">SelectLocalIp</span>(node.<span class="built_in">Ip</span>(), node.<span class="built_in">Port</span>(), &amp;local_ip);</span><br><span class="line">  <span class="keyword">if</span> (s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">    sync_slave_slots_[p_info]-&gt;<span class="built_in">SetLocalIp</span>(local_ip);</span><br><span class="line">    sync_slave_slots_[p_info]-&gt;<span class="built_in">Activate</span>(node, repl_state);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SyncSlaveSlot</span> &#123;</span><br><span class="line"> std::unique_ptr&lt;rsync::RsyncClient&gt; rsync_cli_;</span><br><span class="line"> pstd::Mutex slot_mu_;</span><br><span class="line"> RmNode m_info_;</span><br><span class="line"> ReplState repl_state_&#123;kNoConnect&#125;;</span><br><span class="line"> std::string local_ip_;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SyncMasterSlot</span> &#123;</span><br><span class="line">  <span class="type">int32_t</span> session_id_ = <span class="number">0</span>;</span><br><span class="line">  ConsensusCoordinator coordinator_;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConsensusCoordinator</span> &#123;</span><br><span class="line">  LogOffset committed_index_;</span><br><span class="line">  std::shared_ptr&lt;Context&gt; context_;</span><br><span class="line">  std::shared_mutex term_rwlock_;</span><br><span class="line">  <span class="type">uint32_t</span> term_ = <span class="number">0</span>;</span><br><span class="line">  std::string db_name_;</span><br><span class="line">  <span class="type">uint32_t</span> slot_id_ = <span class="number">0</span>;</span><br><span class="line">  SyncProgress sync_pros_;</span><br><span class="line">  std::shared_ptr&lt;StableLog&gt; stable_logger_;</span><br><span class="line">  std::shared_ptr&lt;MemLog&gt; mem_logger_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="DBSync"><a href="#DBSync" class="headerlink" title="DBSync"></a>DBSync</h2><p><strong>src&#x2F;pika_auxiliary_thread.cc</strong></p>
<p>重新回到辅助线程，由于刚刚把 <code>repl_state_</code> 置为了 <code>PIKA_REPL_META_SYNC_DONE</code> ，并且每个 <code>syncslaveslot</code> 的状态变成了<code>kTryDBSync</code>，所以我们这里我们经过了 <code>MetaSyncDone</code> 判断之后去执行 <code>RunSyncSlaveSlotStateMachine</code> </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="title">PikaAuxiliaryThread::ThreadMain</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (!<span class="built_in">should_stop</span>()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (g_pika_server-&gt;<span class="built_in">ShouldMetaSync</span>()) &#123;</span><br><span class="line">      g_pika_rm-&gt;<span class="built_in">SendMetaSyncRequest</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (g_pika_server-&gt;<span class="built_in">MetaSyncDone</span>()) &#123;</span><br><span class="line">      g_pika_rm-&gt;<span class="built_in">RunSyncSlaveSlotStateMachine</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pstd::Status s = g_pika_rm-&gt;<span class="built_in">CheckSyncTimeout</span>(pstd::<span class="built_in">NowMicros</span>());</span><br><span class="line">    <span class="keyword">if</span> (!s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">      <span class="built_in">LOG</span>(WARNING) &lt;&lt; s.<span class="built_in">ToString</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    g_pika_server-&gt;<span class="built_in">CheckLeaderProtectedMode</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO(whoiami) timeout</span></span><br><span class="line">    s = g_pika_server-&gt;<span class="built_in">TriggerSendBinlogSync</span>();</span><br><span class="line">    <span class="keyword">if</span> (!s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">      <span class="built_in">LOG</span>(WARNING) &lt;&lt; s.<span class="built_in">ToString</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// send to peer</span></span><br><span class="line">    <span class="type">int</span> res = g_pika_server-&gt;<span class="built_in">SendToPeer</span>();</span><br><span class="line">    <span class="keyword">if</span> (res == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// sleep 100 ms</span></span><br><span class="line">      <span class="function">std::unique_lock <span class="title">lock</span><span class="params">(mu_)</span></span>;</span><br><span class="line">      cv_.<span class="built_in">wait_for</span>(lock, <span class="number">100</span>ms);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// LOG_EVERY_N(INFO, 1000) &lt;&lt; &quot;Consume binlog number &quot; &lt;&lt; res;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>src&#x2F;pika_rm.cc</strong></p>
<p>这个用了一个 <code>for</code> 循环去遍历 <code>sync_slave_slots</code> 中每个 <code>slot</code> 的状态，在刚刚的 <code>MetaSync</code> 处理请求结果中，我们将每个 <code>slot</code> 的状态设置成了 <code>kTryDBSync</code> 了，所以这里我们调用的是 <code>SendSlotDBSyncRequest</code> </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">PikaReplicaManager::RunSyncSlaveSlotStateMachine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="function">std::shared_lock <span class="title">l</span><span class="params">(slots_rw_)</span></span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; item : sync_slave_slots_) &#123;</span><br><span class="line">    SlotInfo p_info = item.first;</span><br><span class="line">    std::shared_ptr&lt;SyncSlaveSlot&gt; s_slot = item.second;</span><br><span class="line">    <span class="keyword">if</span> (s_slot-&gt;<span class="built_in">State</span>() == ReplState::kTryConnect) &#123;</span><br><span class="line">      <span class="built_in">SendSlotTrySyncRequest</span>(p_info.db_name_, p_info.slot_id_);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s_slot-&gt;<span class="built_in">State</span>() == ReplState::kTryDBSync) &#123;</span><br><span class="line">      <span class="built_in">SendSlotDBSyncRequest</span>(p_info.db_name_, p_info.slot_id_);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s_slot-&gt;<span class="built_in">State</span>() == ReplState::kWaitReply) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s_slot-&gt;<span class="built_in">State</span>() == ReplState::kWaitDBSync) &#123;</span><br><span class="line">      s_slot-&gt;<span class="built_in">ActivateRsync</span>();</span><br><span class="line">      std::shared_ptr&lt;Slot&gt; slot =</span><br><span class="line">          g_pika_server-&gt;<span class="built_in">GetDBSlotById</span>(p_info.db_name_, p_info.slot_id_);</span><br><span class="line">      <span class="keyword">if</span> (slot) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!s_slot-&gt;<span class="built_in">IsRsyncRunning</span>()) &#123;</span><br><span class="line">          slot-&gt;<span class="built_in">TryUpdateMasterOffset</span>();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Slot not found, DB Name: &quot;</span> &lt;&lt; p_info.db_name_</span><br><span class="line">                     &lt;&lt; <span class="string">&quot; Slot Id: &quot;</span> &lt;&lt; p_info.slot_id_;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s_slot-&gt;<span class="built_in">State</span>() == ReplState::kConnected || s_slot-&gt;<span class="built_in">State</span>() == ReplState::kNoConnect ||</span><br><span class="line">               s_slot-&gt;<span class="built_in">State</span>() == ReplState::kDBNoConnect) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>src&#x2F;pika_rm.cc</strong></p>
<p>这里调用 <code>GetDBSlotBinlogOffset</code> 将从节点自身的 <code>Binlog</code> 的 <code>filenum</code> 和 <code>offset</code> 记录在 <code>boffset</code> 中，调用 <code>PrepareRsync</code> ，在 <code>dbsync_path_</code> 下先删除了之前的文件夹然后重新建立五种数据类型的文件夹. 然后调用了 <code>SendSlotDBSync</code> ，如果成功的话将 <code>repl_state_</code> 的状态设置为 <code>kWaitReply</code> 否则置为 <code>kError</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">PikaReplicaManager::SendSlotDBSyncRequest</span><span class="params">(<span class="type">const</span> std::string&amp; db_name, <span class="type">size_t</span> slot_id)</span> </span>&#123;</span><br><span class="line">  BinlogOffset boffset;</span><br><span class="line">  <span class="keyword">if</span> (!g_pika_server-&gt;<span class="built_in">GetDBSlotBinlogOffset</span>(db_name, slot_id, &amp;boffset)) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Slot: &quot;</span> &lt;&lt; db_name &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; slot_id &lt;&lt; <span class="string">&quot;,  Get slot binlog offset failed&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">Corruption</span>(<span class="string">&quot;Slot get binlog offset error&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::shared_ptr&lt;Slot&gt; slot = g_pika_server-&gt;<span class="built_in">GetDBSlotById</span>(db_name, slot_id);</span><br><span class="line">  <span class="keyword">if</span> (!slot) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Slot: &quot;</span> &lt;&lt; db_name &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; slot_id &lt;&lt; <span class="string">&quot;, NotFound&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">Corruption</span>(<span class="string">&quot;Slot not found&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  slot-&gt;<span class="built_in">PrepareRsync</span>();</span><br><span class="line"></span><br><span class="line">  std::shared_ptr&lt;SyncSlaveSlot&gt; slave_slot =</span><br><span class="line">      <span class="built_in">GetSyncSlaveSlotByName</span>(<span class="built_in">SlotInfo</span>(db_name, slot_id));</span><br><span class="line">  <span class="keyword">if</span> (!slave_slot) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Slave Slot: &quot;</span> &lt;&lt; db_name &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; slot_id &lt;&lt; <span class="string">&quot;, NotFound&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">Corruption</span>(<span class="string">&quot;Slave Slot not found&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Status status = pika_repl_client_-&gt;<span class="built_in">SendSlotDBSync</span>(slave_slot-&gt;<span class="built_in">MasterIp</span>(), slave_slot-&gt;<span class="built_in">MasterPort</span>(),</span><br><span class="line">                                                    db_name, slot_id, boffset, slave_slot-&gt;<span class="built_in">LocalIp</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (status.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">    slave_slot-&gt;<span class="built_in">SetReplState</span>(ReplState::kWaitReply);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    slave_slot-&gt;<span class="built_in">SetReplState</span>(ReplState::kError);</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;SendSlotDBSync failed &quot;</span> &lt;&lt; status.<span class="built_in">ToString</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="FAQ-5"><a href="#FAQ-5" class="headerlink" title="FAQ"></a>FAQ</h2><ul>
<li><p>这里如果发送 <code>DBSync</code> 请求失败了为什么仅仅只是将 <code>repl</code> 状态转为 <code>kError</code>， 而没有其他的措施去解决</p>
</li>
<li><p>这里的 <code>status</code>的返回结果是不是只是 DbSync 是否成功发送出去了的返回，而不是 DbSync 的 Response 返回结果?</p>
<p>​</p>
</li>
</ul>
<p><strong>src&#x2F;pika_repl_client.cc</strong></p>
<p>这里将 <code>InnerMessage</code> 类型设置为 <code>kDBSync</code> 然后将 <code>ip-port</code>, <code>db_name</code> , <code>slot_id</code> ，<code>filenum</code>，<code>offset</code> 传进去，发送给 Master 节点.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">PikaReplClient::SendSlotDBSync</span><span class="params">(<span class="type">const</span> std::string&amp; ip, <span class="type">uint32_t</span> port, <span class="type">const</span> std::string&amp; db_name,</span></span></span><br><span class="line"><span class="params"><span class="function">                                           <span class="type">uint32_t</span> slot_id, <span class="type">const</span> BinlogOffset&amp; boffset,</span></span></span><br><span class="line"><span class="params"><span class="function">                                           <span class="type">const</span> std::string&amp; local_ip)</span> </span>&#123;</span><br><span class="line">  InnerMessage::InnerRequest request;</span><br><span class="line">  request.<span class="built_in">set_type</span>(InnerMessage::kDBSync);</span><br><span class="line">  InnerMessage::InnerRequest::DBSync* db_sync = request.<span class="built_in">mutable_db_sync</span>();</span><br><span class="line">  InnerMessage::Node* node = db_sync-&gt;<span class="built_in">mutable_node</span>();</span><br><span class="line">  node-&gt;<span class="built_in">set_ip</span>(local_ip);</span><br><span class="line">  node-&gt;<span class="built_in">set_port</span>(g_pika_server-&gt;<span class="built_in">port</span>());</span><br><span class="line">  InnerMessage::Slot* slot = db_sync-&gt;<span class="built_in">mutable_slot</span>();</span><br><span class="line">  slot-&gt;<span class="built_in">set_db_name</span>(db_name);</span><br><span class="line">  slot-&gt;<span class="built_in">set_slot_id</span>(slot_id);</span><br><span class="line"></span><br><span class="line">  InnerMessage::BinlogOffset* binlog_offset = db_sync-&gt;<span class="built_in">mutable_binlog_offset</span>();</span><br><span class="line">  binlog_offset-&gt;<span class="built_in">set_filenum</span>(boffset.filenum);</span><br><span class="line">  binlog_offset-&gt;<span class="built_in">set_offset</span>(boffset.offset);</span><br><span class="line"></span><br><span class="line">  std::string to_send;</span><br><span class="line">  <span class="keyword">if</span> (!request.<span class="built_in">SerializeToString</span>(&amp;to_send)) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Serialize Slot DBSync Request Failed, to Master (&quot;</span> &lt;&lt; ip &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; port &lt;&lt; <span class="string">&quot;)&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">Corruption</span>(<span class="string">&quot;Serialize Failed&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> client_thread_-&gt;<span class="built_in">Write</span>(ip, <span class="built_in">static_cast</span>&lt;<span class="type">int32_t</span>&gt;(port) + kPortShiftReplServer, to_send);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>小结</strong></p>
<p>从节点发送的 <code>DBSync</code> 请求中，发送了 <code>ip</code> , <code>port</code> , <code>db_name</code> , <code>slot_id</code>, <code>filenum</code>, <code>offset</code></p>
<p><strong>src&#x2F;pika_repl_server_conn.cc</strong></p>
<p>这里主节点将从节点信息写到 <code>syncmasterslot</code> 中的 <code>slave_</code>中以及 Pika_repl_server 中的 <code>client_conn_map</code> 中，然后调用 <code>DoBgSaveSlot</code> 执行 <code>Bgsave</code> 操作，注意这里调用的端口是目标端口 + <code>1000</code>，最后调用 <code>ActivateSlaveDbSync</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">int</span> kPortShiftRSync = <span class="number">1000</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PikaReplServerConn::HandleDBSyncRequest</span><span class="params">(<span class="type">void</span>* arg)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="type">bool</span> prior_success = <span class="literal">true</span>;</span><br><span class="line">  std::shared_ptr&lt;SyncMasterSlot&gt; master_slot =</span><br><span class="line">      g_pika_rm-&gt;<span class="built_in">GetSyncMasterSlotByName</span>(<span class="built_in">SlotInfo</span>(db_name, slot_id));</span><br><span class="line">  <span class="keyword">if</span> (!master_slot) &#123;</span><br><span class="line">    ...</span><br><span class="line">    prior_success = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (prior_success) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!master_slot-&gt;<span class="built_in">CheckSlaveNodeExist</span>(node.<span class="built_in">ip</span>(), node.<span class="built_in">port</span>())) &#123;</span><br><span class="line">      <span class="type">int32_t</span> session_id = master_slot-&gt;<span class="built_in">GenSessionId</span>();</span><br><span class="line">      <span class="keyword">if</span> (session_id == <span class="number">-1</span>) &#123;</span><br><span class="line">        response.<span class="built_in">set_code</span>(InnerMessage::kError);</span><br><span class="line">        ...</span><br><span class="line">        prior_success = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (prior_success) &#123;</span><br><span class="line">        db_sync_response-&gt;<span class="built_in">set_session_id</span>(session_id);</span><br><span class="line">        Status s = master_slot-&gt;<span class="built_in">AddSlaveNode</span>(node.<span class="built_in">ip</span>(), node.<span class="built_in">port</span>(), session_id);</span><br><span class="line">        <span class="keyword">if</span> (s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">          <span class="type">const</span> std::string ip_port = pstd::<span class="built_in">IpPortString</span>(node.<span class="built_in">ip</span>(), node.<span class="built_in">port</span>());</span><br><span class="line">          g_pika_rm-&gt;<span class="built_in">ReplServerUpdateClientConnMap</span>(ip_port, conn-&gt;<span class="built_in">fd</span>());</span><br><span class="line">          ...</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        db_sync_response-&gt;<span class="built_in">set_session_id</span>(<span class="number">-1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="type">int32_t</span> session_id;</span><br><span class="line">      Status s = master_slot-&gt;<span class="built_in">GetSlaveNodeSession</span>(node.<span class="built_in">ip</span>(), node.<span class="built_in">port</span>(), &amp;session_id);</span><br><span class="line">      <span class="keyword">if</span> (!s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">        response.<span class="built_in">set_code</span>(InnerMessage::kError);</span><br><span class="line">        ...</span><br><span class="line">        db_sync_response-&gt;<span class="built_in">set_session_id</span>(<span class="number">-1</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  g_pika_server-&gt;<span class="built_in">DoBgSaveSlot</span>(node.<span class="built_in">ip</span>(), node.<span class="built_in">port</span>() + kPortShiftRSync, db_name, slot_id,</span><br><span class="line">                           <span class="built_in">static_cast</span>&lt;<span class="type">int32_t</span>&gt;(slave_boffset.<span class="built_in">filenum</span>()));</span><br><span class="line">  ...</span><br><span class="line">  master_slot-&gt;<span class="built_in">ActivateSlaveDbSync</span>(node.<span class="built_in">ip</span>(), node.<span class="built_in">port</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!response.<span class="built_in">SerializeToString</span>(&amp;reply_str) || (conn-&gt;<span class="built_in">WriteResp</span>(reply_str) != <span class="number">0</span>)) &#123;</span><br><span class="line">    ...</span><br><span class="line">    conn-&gt;<span class="built_in">NotifyClose</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  conn-&gt;<span class="built_in">NotifyWrite</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>src&#x2F;pika_server.cc</strong></p>
<p>根据 <code>bgsave_info</code> 的信息判断是否需要重新进行 <code>bgsave</code> 产生 <code>dump</code> 文件, 当 <code>dump</code> 文件夹不存在或者上次进行 <code>bgsave</code> 时的 <code>binlog</code> 已经不存在或者从节点的<code>binlog_filenum</code> 已经大于自己且超过阈值(50)，那么需要重新进行 <code>bgsave</code>，否则使用原来的 <code>dump</code> 文件</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PikaServer::DoBgSaveSlot</span><span class="params">(<span class="type">const</span> std::string&amp; ip, <span class="type">int</span> port, <span class="type">const</span> std::string&amp; db_name, <span class="type">uint32_t</span> slot_id, <span class="type">int32_t</span> top)</span> </span>&#123;</span><br><span class="line">  std::shared_ptr&lt;Slot&gt; slot = <span class="built_in">GetDBSlotById</span>(db_name, slot_id);</span><br><span class="line">  <span class="keyword">if</span> (!slot) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;can not find Slot whose id is &quot;</span> &lt;&lt; slot_id &lt;&lt; <span class="string">&quot; in db &quot;</span> &lt;&lt; db_name &lt;&lt; <span class="string">&quot;, DoBgSaveSlot Failed&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  std::shared_ptr&lt;SyncMasterSlot&gt; sync_slot = g_pika_rm-&gt;<span class="built_in">GetSyncMasterSlotByName</span>(<span class="built_in">SlotInfo</span>(db_name, slot_id));</span><br><span class="line">  <span class="keyword">if</span> (!sync_slot) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;can not find Slot whose id is &quot;</span> &lt;&lt; slot_id &lt;&lt; <span class="string">&quot; in db &quot;</span> &lt;&lt; db_name &lt;&lt; <span class="string">&quot;, DoBgSaveSlot Failed&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  BgSaveInfo bgsave_info = slot-&gt;<span class="built_in">bgsave_info</span>();</span><br><span class="line">  std::string logger_filename = sync_slot-&gt;<span class="built_in">Logger</span>()-&gt;<span class="built_in">filename</span>();</span><br><span class="line">  <span class="keyword">if</span> (pstd::<span class="built_in">IsDir</span>(bgsave_info.path) != <span class="number">0</span> ||</span><br><span class="line">      !pstd::<span class="built_in">FileExists</span>(<span class="built_in">NewFileName</span>(logger_filename, bgsave_info.offset.b_offset.filenum)) ||</span><br><span class="line">      top - bgsave_info.offset.b_offset.filenum &gt; kDBSyncMaxGap) &#123;</span><br><span class="line">    <span class="comment">// Need Bgsave first</span></span><br><span class="line">    slot-&gt;<span class="built_in">BgSaveSlot</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>src&#x2F;pika_rm.cc</strong></p>
<p>在 <code>ActivateSlaveDbsync</code> 中将 <code>Slave</code> 节点的状态置为 <code>kSlaveDbSync</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">SyncMasterSlot::ActivateSlaveDbSync</span><span class="params">(<span class="type">const</span> std::string&amp; ip, <span class="type">int</span> port)</span> </span>&#123;</span><br><span class="line">  std::shared_ptr&lt;SlaveNode&gt; slave_ptr = <span class="built_in">GetSlaveNode</span>(ip, port);</span><br><span class="line">  <span class="keyword">if</span> (!slave_ptr) &#123;</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">NotFound</span>(<span class="string">&quot;ip &quot;</span> + ip + <span class="string">&quot; port &quot;</span> + std::<span class="built_in">to_string</span>(port));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  slave_ptr-&gt;<span class="built_in">Lock</span>();</span><br><span class="line">  slave_ptr-&gt;slave_state = kSlaveDbSync;</span><br><span class="line">  <span class="comment">// invoke db sync</span></span><br><span class="line">  slave_ptr-&gt;<span class="built_in">Unlock</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// rm define</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">SlaveState</span> &#123;</span><br><span class="line">  kSlaveNotSync = <span class="number">0</span>,</span><br><span class="line">  kSlaveDbSync = <span class="number">1</span>,</span><br><span class="line">  kSlaveBinlogSync = <span class="number">2</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="FAQ-6"><a href="#FAQ-6" class="headerlink" title="FAQ"></a>FAQ</h2><ul>
<li><p>为什么 <code>top - bgsave_info.offset.b_offset.filenum &gt; kDBSyncMaxGap</code> 当从节点的 <code>filenum</code> 比主节点的之前 <code>bgsave</code> 的 <code>filenum</code>相减大于 50 这个条件要进行 bgsave 操作</p>
</li>
<li><p>这个 <code>ActivateSlaveDbSync</code> 函数有用吗</p>
<p>​</p>
</li>
</ul>
<h3 id="DBSync总结"><a href="#DBSync总结" class="headerlink" title="DBSync总结"></a>DBSync总结</h3><p>在 <code>DBSync</code> 中主节点给从节点的回包信息中写了 <code>session_id</code>, <code>db_name</code>, <code>slot_id</code>,同时主节点根据判断做出是不是要进行 <code>bgsave</code> 操作</p>
<img width="829" alt="截屏2024-01-25 10 11 46" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/bbc330ff-2c84-4e1a-9004-a6cd96a3fedc">



<p><strong>src&#x2F;pika_repl_client_conn.cc</strong></p>
<p>从节点收到 Master 节点的 <code>DBSync</code> 回包后，设置一下自己的 <code>session_id</code>, 然后停止 <code>Rsync</code>线程，将状态改为 <code>kWaitDBSync</code> </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PikaReplClientConn::HandleDBSyncResponse</span><span class="params">(<span class="type">void</span>* arg)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (response-&gt;<span class="built_in">code</span>() != InnerMessage::kOk) &#123;</span><br><span class="line">    slave_slot-&gt;<span class="built_in">SetReplState</span>(ReplState::kError);</span><br><span class="line">    std::string reply = response-&gt;<span class="built_in">has_reply</span>() ? response-&gt;<span class="built_in">reply</span>() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;DBSync Failed: &quot;</span> &lt;&lt; reply;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  slave_slot-&gt;<span class="built_in">SetMasterSessionId</span>(session_id);</span><br><span class="line"></span><br><span class="line">  std::string slot_name = slave_slot-&gt;<span class="built_in">SlotName</span>();</span><br><span class="line">  slave_slot-&gt;<span class="built_in">StopRsync</span>();</span><br><span class="line">  slave_slot-&gt;<span class="built_in">SetReplState</span>(ReplState::kWaitDBSync);</span><br><span class="line">  <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Slot: &quot;</span> &lt;&lt; slot_name &lt;&lt; <span class="string">&quot; Need Wait To Sync&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="FAQ-7"><a href="#FAQ-7" class="headerlink" title="FAQ"></a>FAQ</h2><ul>
<li><p>为什么这里回包的状态不等于 <code>kOK</code> 不需要触发 <code>SyncError</code></p>
<p>不成功的状态可能是主节点 <code>AddSlaveNode</code> 操作失败，可以等待下次请求再次尝试</p>
</li>
</ul>
<h2 id="RsyncMeta"><a href="#RsyncMeta" class="headerlink" title="RsyncMeta"></a>RsyncMeta</h2><p><strong>src&#x2F;pika_rm.cc</strong></p>
<p>再次回到这个 for 循环，由于我们现在是 <code>kWaitDBSync</code> 状态，所以我们调用 <code>ActivateRsync</code>启动了 <code>Rsync</code> 线程</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">PikaReplicaManager::RunSyncSlaveSlotStateMachine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="function">std::shared_lock <span class="title">l</span><span class="params">(slots_rw_)</span></span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; item : sync_slave_slots_) &#123;</span><br><span class="line">    SlotInfo p_info = item.first;</span><br><span class="line">    std::shared_ptr&lt;SyncSlaveSlot&gt; s_slot = item.second;</span><br><span class="line">    <span class="keyword">if</span> (s_slot-&gt;<span class="built_in">State</span>() == ReplState::kTryConnect) &#123;</span><br><span class="line">      <span class="built_in">SendSlotTrySyncRequest</span>(p_info.db_name_, p_info.slot_id_);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s_slot-&gt;<span class="built_in">State</span>() == ReplState::kTryDBSync) &#123;</span><br><span class="line">      <span class="built_in">SendSlotDBSyncRequest</span>(p_info.db_name_, p_info.slot_id_);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s_slot-&gt;<span class="built_in">State</span>() == ReplState::kWaitReply) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s_slot-&gt;<span class="built_in">State</span>() == ReplState::kWaitDBSync) &#123;</span><br><span class="line">      s_slot-&gt;<span class="built_in">ActivateRsync</span>();</span><br><span class="line">      std::shared_ptr&lt;Slot&gt; slot =</span><br><span class="line">          g_pika_server-&gt;<span class="built_in">GetDBSlotById</span>(p_info.db_name_, p_info.slot_id_);</span><br><span class="line">      <span class="keyword">if</span> (slot) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!s_slot-&gt;<span class="built_in">IsRsyncRunning</span>()) &#123;</span><br><span class="line">          slot-&gt;<span class="built_in">TryUpdateMasterOffset</span>();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Slot not found, DB Name: &quot;</span> &lt;&lt; p_info.db_name_</span><br><span class="line">                     &lt;&lt; <span class="string">&quot; Slot Id: &quot;</span> &lt;&lt; p_info.slot_id_;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s_slot-&gt;<span class="built_in">State</span>() == ReplState::kConnected || s_slot-&gt;<span class="built_in">State</span>() == ReplState::kNoConnect ||</span><br><span class="line">               s_slot-&gt;<span class="built_in">State</span>() == ReplState::kDBNoConnect) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>src&#x2F;pika_rm.cc</strong></p>
<p>在 <code>ActivateRsync</code> 中先调用 <code>Init()</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">SyncSlaveSlot::ActivateRsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!rsync_cli_-&gt;<span class="built_in">IsIdle</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;ActivateRsync ...&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> (rsync_cli_-&gt;<span class="built_in">Init</span>()) &#123;</span><br><span class="line">    rsync_cli_-&gt;<span class="built_in">Start</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>src&#x2F;rsync_client.cc</strong></p>
<p>这里使用 <code>port</code> + 偏移量(10001) 作为 <code>master_port_</code> 这个 <code>Rsync</code> 的端口</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">RsyncClient::Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (state_ != IDLE) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;State should be IDLE when Init&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  master_ip_ = g_pika_server-&gt;<span class="built_in">master_ip</span>();</span><br><span class="line">  master_port_ = g_pika_server-&gt;<span class="built_in">master_port</span>() + kPortShiftRsync2;</span><br><span class="line">  file_set_.<span class="built_in">clear</span>();</span><br><span class="line">  client_thread_-&gt;<span class="built_in">StartThread</span>();</span><br><span class="line">  <span class="type">bool</span> ret = <span class="built_in">Recover</span>();</span><br><span class="line">  <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;RsyncClient recover failed&quot;</span>;</span><br><span class="line">    client_thread_-&gt;<span class="built_in">StopThread</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  finished_work_cnt_.<span class="built_in">store</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;RsyncClient recover success&quot;</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="FAQ-8"><a href="#FAQ-8" class="headerlink" title="FAQ"></a>FAQ</h2><ul>
<li><p>这里的 <code>client_thread</code> 线程是什么</p>
<p>​</p>
</li>
</ul>
<p><strong>src&#x2F;rsync_client.cc</strong></p>
<p>在 <code>Recover</code> 中，我们先调用了 <code>CopyRemoteMeta</code> 函数用于拉取远端 <code>dump</code> 文件中的元信息，然后再根据本地的信息进行对比，去更新数据</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">RsyncClient::Recover</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  std::string local_snapshot_uuid;</span><br><span class="line">  std::string remote_snapshot_uuid;</span><br><span class="line">  std::set&lt;std::string&gt; local_file_set;</span><br><span class="line">  std::set&lt;std::string&gt; remote_file_set;</span><br><span class="line">  std::map&lt;std::string, std::string&gt; local_file_map;</span><br><span class="line"></span><br><span class="line">  Status s = <span class="built_in">CopyRemoteMeta</span>(&amp;remote_snapshot_uuid, &amp;remote_file_set);</span><br><span class="line">  ...</span><br><span class="line">  s = <span class="built_in">LoadLocalMeta</span>(&amp;local_snapshot_uuid, &amp;local_file_map);</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> <span class="type">const</span>&amp; file : local_file_map) &#123;</span><br><span class="line">    local_file_set.<span class="built_in">insert</span>(file.first);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::set&lt;std::string&gt; expired_files;</span><br><span class="line">  <span class="keyword">if</span> (remote_snapshot_uuid != local_snapshot_uuid) &#123;</span><br><span class="line">    snapshot_uuid_ = remote_snapshot_uuid;</span><br><span class="line">    file_set_ = remote_file_set;</span><br><span class="line">    expired_files = local_file_set;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    std::set&lt;std::string&gt; newly_files;</span><br><span class="line">    <span class="built_in">set_difference</span>(remote_file_set.<span class="built_in">begin</span>(), remote_file_set.<span class="built_in">end</span>(),</span><br><span class="line">                   local_file_set.<span class="built_in">begin</span>(), local_file_set.<span class="built_in">end</span>(),</span><br><span class="line">                   <span class="built_in">inserter</span>(newly_files, newly_files.<span class="built_in">begin</span>()));</span><br><span class="line">    <span class="built_in">set_difference</span>(local_file_set.<span class="built_in">begin</span>(), local_file_set.<span class="built_in">end</span>(),</span><br><span class="line">                   remote_file_set.<span class="built_in">begin</span>(), remote_file_set.<span class="built_in">end</span>(),</span><br><span class="line">                   <span class="built_in">inserter</span>(expired_files, expired_files.<span class="built_in">begin</span>()));</span><br><span class="line">    file_set_.<span class="built_in">insert</span>(newly_files.<span class="built_in">begin</span>(), newly_files.<span class="built_in">end</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  s = <span class="built_in">CleanUpExpiredFiles</span>(local_snapshot_uuid != remote_snapshot_uuid, expired_files);</span><br><span class="line">  ...</span><br><span class="line">  s = <span class="built_in">UpdateLocalMeta</span>(snapshot_uuid_, expired_files, &amp;local_file_map);</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  state_ = RUNNING;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="FAQ-9"><a href="#FAQ-9" class="headerlink" title="FAQ"></a>FAQ</h2><ul>
<li><p>为什么这里还需要对比一下本地的数据，直接覆盖不可以吗</p>
<p>​</p>
</li>
</ul>
<p><strong>src&#x2F;rsync_client.cc</strong></p>
<p>这里封装了一个 <code>RsyncRequest</code> 里面有 <code>db_name</code> , <code>slot_id</code>, <code>kRsyncMeta</code>, <code>reader_index</code> 然后发送给 Master，收到 <code>resp</code> 后将 Master 发给自己的 <code>Dump </code>文件的元信息记录到 <code>file_set</code> 中，同时更新 <code>snapshot_uuid</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">RsyncClient::CopyRemoteMeta</span><span class="params">(std::string* snapshot_uuid, std::set&lt;std::string&gt;* file_set)</span> </span>&#123;</span><br><span class="line">  Status s;</span><br><span class="line">  <span class="type">int</span> retries = <span class="number">0</span>;</span><br><span class="line">  RsyncRequest request;</span><br><span class="line">  request.<span class="built_in">set_reader_index</span>(<span class="number">0</span>);</span><br><span class="line">  request.<span class="built_in">set_db_name</span>(db_name_);</span><br><span class="line">  request.<span class="built_in">set_slot_id</span>(slot_id_);</span><br><span class="line">  request.<span class="built_in">set_type</span>(kRsyncMeta);</span><br><span class="line">  std::string to_send;</span><br><span class="line">  request.<span class="built_in">SerializeToString</span>(&amp;to_send);</span><br><span class="line">  <span class="keyword">while</span> (retries &lt; max_retries_) &#123;</span><br><span class="line">    WaitObject* wo = wo_mgr_-&gt;<span class="built_in">UpdateWaitObject</span>(<span class="number">0</span>, <span class="string">&quot;&quot;</span>, kRsyncMeta, kInvalidOffset);</span><br><span class="line">    s = client_thread_-&gt;<span class="built_in">Write</span>(master_ip_, master_port_, to_send);</span><br><span class="line">    <span class="keyword">if</span> (!s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">      retries++;</span><br><span class="line">    &#125;</span><br><span class="line">    std::shared_ptr&lt;RsyncResponse&gt; resp;</span><br><span class="line">    s = wo-&gt;<span class="built_in">Wait</span>(resp);</span><br><span class="line">    <span class="keyword">if</span> (s.<span class="built_in">IsTimeout</span>() || resp.<span class="built_in">get</span>() == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;rsync CopyRemoteMeta request timeout, &quot;</span></span><br><span class="line">                   &lt;&lt; <span class="string">&quot;retry times: &quot;</span> &lt;&lt; retries;</span><br><span class="line">      retries++;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (resp-&gt;<span class="built_in">code</span>() != RsyncService::kOk) &#123;</span><br><span class="line">      <span class="comment">//<span class="doctag">TODO:</span> handle different error</span></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;receive rsync meta infos, snapshot_uuid: &quot;</span> &lt;&lt; resp-&gt;<span class="built_in">snapshot_uuid</span>()</span><br><span class="line">              &lt;&lt; <span class="string">&quot;files count: &quot;</span> &lt;&lt; resp-&gt;<span class="built_in">meta_resp</span>().<span class="built_in">filenames_size</span>();</span><br><span class="line">    <span class="keyword">for</span> (std::string item : resp-&gt;<span class="built_in">meta_resp</span>().<span class="built_in">filenames</span>()) &#123;</span><br><span class="line">      file_set-&gt;<span class="built_in">insert</span>(item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *snapshot_uuid = resp-&gt;<span class="built_in">snapshot_uuid</span>();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>小结</strong></p>
<p>从节点发送的 <code>RsyncMeta</code> 请求中包含了 <code>db_name</code>, <code>slot_id</code>, <code>reader_index</code></p>
<p><strong>src&#x2F;rsync_server.cc</strong></p>
<p>Master 端处理 <code>MetaRsync</code> 请求，如果当前的 <code>slot</code> 正在做 <code>bgsave</code> 的话会直接返回，如果没有调用 <code>GetDumpMeta</code> 将 <code>Dump</code> 文件中的元信息记录到 <code>filenames</code>中，然后一并返回给 <code>Slave</code>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">RsyncServerConn::HandleMetaRsyncRequest</span><span class="params">(<span class="type">void</span>* arg)</span> </span>&#123;</span><br><span class="line">  <span class="function">std::unique_ptr&lt;RsyncServerTaskArg&gt; <span class="title">task_arg</span><span class="params">(<span class="keyword">static_cast</span>&lt;RsyncServerTaskArg*&gt;(arg))</span></span>;</span><br><span class="line">  <span class="type">const</span> std::shared_ptr&lt;RsyncService::RsyncRequest&gt; req = task_arg-&gt;req;</span><br><span class="line">  std::shared_ptr&lt;net::PbConn&gt; conn = task_arg-&gt;conn;</span><br><span class="line">  std::string db_name = req-&gt;<span class="built_in">db_name</span>();</span><br><span class="line">  <span class="type">uint32_t</span> slot_id = req-&gt;<span class="built_in">slot_id</span>();</span><br><span class="line">  std::shared_ptr&lt;Slot&gt; slot = g_pika_server-&gt;<span class="built_in">GetDBSlotById</span>(db_name, slot_id);</span><br><span class="line">  <span class="keyword">if</span> (!slot || slot-&gt;<span class="built_in">IsBgSaving</span>()) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;waiting bgsave done...&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  RsyncService::RsyncResponse response;</span><br><span class="line">  response.<span class="built_in">set_reader_index</span>(req-&gt;<span class="built_in">reader_index</span>());</span><br><span class="line">  response.<span class="built_in">set_code</span>(RsyncService::kOk);</span><br><span class="line">  response.<span class="built_in">set_type</span>(RsyncService::kRsyncMeta);</span><br><span class="line">  response.<span class="built_in">set_db_name</span>(db_name);</span><br><span class="line">  response.<span class="built_in">set_slot_id</span>(slot_id);</span><br><span class="line"></span><br><span class="line">  std::vector&lt;std::string&gt; filenames;</span><br><span class="line">  std::string snapshot_uuid;</span><br><span class="line">  g_pika_server-&gt;<span class="built_in">GetDumpMeta</span>(db_name, slot_id, &amp;filenames, &amp;snapshot_uuid);</span><br><span class="line">  response.<span class="built_in">set_snapshot_uuid</span>(snapshot_uuid);</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  RsyncService::MetaResponse* meta_resp = response.<span class="built_in">mutable_meta_resp</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; filename : filenames) &#123;</span><br><span class="line">        meta_resp-&gt;<span class="built_in">add_filenames</span>(filename);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">RsyncWriteResp</span>(response, conn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="FAQ-10"><a href="#FAQ-10" class="headerlink" title="FAQ"></a>FAQ</h2><ul>
<li><p>为什么这里主节点的回包中 <code>reader_index</code> 复用的是 <code>request</code> 传进来的 <code>reader_index</code></p>
<p>​</p>
</li>
</ul>
<h2 id="RsyncMeta总结"><a href="#RsyncMeta总结" class="headerlink" title="RsyncMeta总结"></a>RsyncMeta总结</h2><p>在 <code>MetaRsync</code> 请求中，主节点给从节点的回包包括 <code>db_name</code> , <code>slot_id</code> , <code>reader_index</code>, <code>snapshot_uuid</code>, <code>filename</code></p>
<img width="801" alt="截屏2024-01-25 10 12 17" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/d4d5d1ba-8796-4149-a991-d8eff6cbe299">

<h2 id="RsyncFile"><a href="#RsyncFile" class="headerlink" title="RsyncFile"></a>RsyncFile</h2><p><strong>src&#x2F;rsync_client.cc</strong></p>
<p>在 <code>file_set_</code> 里面保存着远端文件的元信息之后，<code>work_threads</code> 就开始调用 <code>Copy</code> 去远端拉取文件</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="title">RsyncClient::ThreadMain</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  std::vector&lt;std::set&lt;std::string&gt; &gt; <span class="built_in">file_vec</span>(<span class="built_in">GetParallelNum</span>());</span><br><span class="line">  <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; file : file_set_) &#123;</span><br><span class="line">    file_vec[index++ % <span class="built_in">GetParallelNum</span>()].<span class="built_in">insert</span>(file);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">GetParallelNum</span>(); i++) &#123;</span><br><span class="line">    work_threads_[i] = std::<span class="built_in">move</span>(std::<span class="built_in">thread</span>(&amp;RsyncClient::Copy, <span class="keyword">this</span>, file_vec[i], i));</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (state_.<span class="built_in">load</span>() == RUNNING) &#123;</span><br><span class="line">    <span class="type">uint64_t</span> elapse = pstd::<span class="built_in">NowMicros</span>() - start_time;</span><br><span class="line">    <span class="keyword">if</span> (elapse &lt; kFlushIntervalUs) &#123;</span><br><span class="line">      <span class="type">int</span> wait_for_us = kFlushIntervalUs - elapse;</span><br><span class="line">      <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mu_)</span></span>;</span><br><span class="line">      cond_.<span class="built_in">wait_for</span>(lock, std::chrono::<span class="built_in">microseconds</span>(wait_for_us));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (state_.<span class="built_in">load</span>() != RUNNING) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    start_time = pstd::<span class="built_in">NowMicros</span>();</span><br><span class="line">    std::map&lt;std::string, std::string&gt; files_map;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">guard</span><span class="params">(mu_)</span></span>;</span><br><span class="line">      files_map.<span class="built_in">swap</span>(meta_table_);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; file : files_map) &#123;</span><br><span class="line">      meta_rep.<span class="built_in">append</span>(file.first + <span class="string">&quot;:&quot;</span> + file.second);</span><br><span class="line">      meta_rep.<span class="built_in">append</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (finished_work_cnt_.<span class="built_in">load</span>() == <span class="built_in">GetParallelNum</span>()) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">GetParallelNum</span>(); i++) &#123;</span><br><span class="line">    work_threads_[i].<span class="built_in">join</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  finished_work_cnt_.<span class="built_in">store</span>(<span class="number">0</span>);</span><br><span class="line">  state_.<span class="built_in">store</span>(STOP);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="FAQ-11"><a href="#FAQ-11" class="headerlink" title="FAQ"></a>FAQ</h2><ul>
<li><p>这里的 <code>COPY</code> 函数的入参怎么确定</p>
<p>​</p>
</li>
</ul>
<p><strong>src&#x2F;rsync_client.cc</strong></p>
<p>调用 <code>CopyRemoteFile</code> 去远程拉取文件</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">RsyncClient::Copy</span><span class="params">(<span class="type">const</span> std::set&lt;std::string&gt;&amp; file_set, <span class="type">int</span> index)</span> </span>&#123;</span><br><span class="line">  Status s = Status::<span class="built_in">OK</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; file : file_set) &#123;</span><br><span class="line">    <span class="keyword">while</span> (state_.<span class="built_in">load</span>() == RUNNING) &#123;</span><br><span class="line">      <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;copy remote file, filename: &quot;</span> &lt;&lt; file;</span><br><span class="line">      s = <span class="built_in">CopyRemoteFile</span>(file, index);</span><br><span class="line">      <span class="keyword">if</span> (!s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">        <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;copy remote file failed, msg: &quot;</span> &lt;&lt; s.<span class="built_in">ToString</span>();</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (state_.<span class="built_in">load</span>() != RUNNING) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;work_thread index: &quot;</span> &lt;&lt; index &lt;&lt; <span class="string">&quot; copy remote files done&quot;</span>;</span><br><span class="line">  finished_work_cnt_.<span class="built_in">fetch_add</span>(<span class="number">1</span>);</span><br><span class="line">  cond_.<span class="built_in">notify_all</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>src&#x2F;rsync_client.cc</strong></p>
<p>这里封装了请求 <code>RsyncRequest</code> ，发给 Master 端 <code>reader_index</code>, <code>db_name</code> , <code>slot_id</code> , <code>filename</code> , <code>offset</code>, <code>count</code>, 同时指定了写文件的路径 <code>dbsync</code>, 当 Master 端回包的时候，调用 <code>Writer</code> 在路径下写文件.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">RsyncClient::CopyRemoteFile</span><span class="params">(<span class="type">const</span> std::string&amp; filename, <span class="type">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> std::string filepath = dir_ + <span class="string">&quot;/&quot;</span> + filename;</span><br><span class="line">    <span class="function">std::unique_ptr&lt;RsyncWriter&gt; <span class="title">writer</span><span class="params">(<span class="keyword">new</span> RsyncWriter(filepath))</span></span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">while</span> (retries &lt; max_retries_) &#123;</span><br><span class="line">      <span class="keyword">if</span> (state_.<span class="built_in">load</span>() != RUNNING) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="type">size_t</span> copy_file_begin_time = pstd::<span class="built_in">NowMicros</span>();</span><br><span class="line">      <span class="type">size_t</span> count = Throttle::<span class="built_in">GetInstance</span>().<span class="built_in">ThrottledByThroughput</span>(kBytesPerRequest);</span><br><span class="line">      <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">1000</span> / kThrottleCheckCycle));</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      RsyncRequest request;</span><br><span class="line">      request.<span class="built_in">set_reader_index</span>(index);</span><br><span class="line">      request.<span class="built_in">set_type</span>(kRsyncFile);</span><br><span class="line">      request.<span class="built_in">set_db_name</span>(db_name_);</span><br><span class="line">      request.<span class="built_in">set_slot_id</span>(slot_id_);</span><br><span class="line">      FileRequest* file_req = request.<span class="built_in">mutable_file_req</span>();</span><br><span class="line">      file_req-&gt;<span class="built_in">set_filename</span>(filename);</span><br><span class="line">      file_req-&gt;<span class="built_in">set_offset</span>(offset);</span><br><span class="line">      file_req-&gt;<span class="built_in">set_count</span>(count);</span><br><span class="line"></span><br><span class="line">      std::string to_send;</span><br><span class="line">      request.<span class="built_in">SerializeToString</span>(&amp;to_send);</span><br><span class="line">      WaitObject* wo = wo_mgr_-&gt;<span class="built_in">UpdateWaitObject</span>(index, filename, kRsyncFile, offset);</span><br><span class="line">      s = client_thread_-&gt;<span class="built_in">Write</span>(master_ip_, master_port_, to_send);</span><br><span class="line">      ...</span><br><span class="line">      std::shared_ptr&lt;RsyncResponse&gt; resp = <span class="literal">nullptr</span>;</span><br><span class="line">      s = wo-&gt;<span class="built_in">Wait</span>(resp);</span><br><span class="line">      ...</span><br><span class="line">      <span class="type">size_t</span> ret_count = resp-&gt;<span class="built_in">file_resp</span>().<span class="built_in">count</span>();</span><br><span class="line">      <span class="type">size_t</span> elaspe_time_us = pstd::<span class="built_in">NowMicros</span>() - copy_file_begin_time;</span><br><span class="line">      Throttle::<span class="built_in">GetInstance</span>().<span class="built_in">ReturnUnusedThroughput</span>(count, ret_count, elaspe_time_us);</span><br><span class="line">      ...</span><br><span class="line">      s = writer-&gt;<span class="built_in">Write</span>((<span class="type">uint64_t</span>)offset, ret_count, resp-&gt;<span class="built_in">file_resp</span>().<span class="built_in">data</span>().<span class="built_in">c_str</span>());</span><br><span class="line">      ...</span><br><span class="line">      offset += resp-&gt;<span class="built_in">file_resp</span>().<span class="built_in">count</span>();</span><br><span class="line">      <span class="keyword">if</span> (resp-&gt;<span class="built_in">file_resp</span>().<span class="built_in">eof</span>()) &#123;</span><br><span class="line">        s = writer-&gt;<span class="built_in">Fsync</span>();</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      retries = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>小结</strong></p>
<p>这里从节点发送的 <code>RsyncFile</code> 请求中包括 <code>db_name</code>, <code>slot_id</code>, <code>reader_index</code>, <code>filename</code>, <code>offset</code>, <code>count</code></p>
<p><strong>src&#x2F;rsync_server.cc</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">RsyncServerConn::HandleFileRsyncRequest</span><span class="params">(<span class="type">void</span>* arg)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  std::string snapshot_uuid;</span><br><span class="line">  Status s = g_pika_server-&gt;<span class="built_in">GetDumpUUID</span>(db_name, slot_id, &amp;snapshot_uuid);</span><br><span class="line">  response.<span class="built_in">set_snapshot_uuid</span>(snapshot_uuid);</span><br><span class="line">  <span class="keyword">if</span> (!s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;rsyncserver get snapshotUUID failed&quot;</span>;</span><br><span class="line">    response.<span class="built_in">set_code</span>(RsyncService::kErr);</span><br><span class="line">    <span class="built_in">RsyncWriteResp</span>(response, conn);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::shared_ptr&lt;Slot&gt; slot = g_pika_server-&gt;<span class="built_in">GetDBSlotById</span>(db_name, slot_id);</span><br><span class="line">  <span class="keyword">if</span> (!slot) &#123;</span><br><span class="line">   <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;cannot find slot for db_name: &quot;</span> &lt;&lt; db_name</span><br><span class="line">                &lt;&lt; <span class="string">&quot; slot_id: &quot;</span> &lt;&lt; slot_id;</span><br><span class="line">   response.<span class="built_in">set_code</span>(RsyncService::kErr);</span><br><span class="line">   <span class="built_in">RsyncWriteResp</span>(response, conn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> std::string filepath = slot-&gt;<span class="built_in">bgsave_info</span>().path + <span class="string">&quot;/&quot;</span> + filename;</span><br><span class="line">  <span class="type">char</span>* buffer = <span class="keyword">new</span> <span class="type">char</span>[req-&gt;<span class="built_in">file_req</span>().<span class="built_in">count</span>() + <span class="number">1</span>];</span><br><span class="line">  <span class="type">size_t</span> bytes_read&#123;<span class="number">0</span>&#125;;</span><br><span class="line">  std::string checksum = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="type">bool</span> is_eof = <span class="literal">false</span>;</span><br><span class="line">  std::shared_ptr&lt;RsyncReader&gt; reader = conn-&gt;readers_[req-&gt;<span class="built_in">reader_index</span>()];</span><br><span class="line">  s = reader-&gt;<span class="built_in">Read</span>(filepath, offset, count, buffer,</span><br><span class="line">                   &amp;bytes_read, &amp;checksum, &amp;is_eof);</span><br><span class="line">  <span class="keyword">if</span> (!s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">    response.<span class="built_in">set_code</span>(RsyncService::kErr);</span><br><span class="line">    <span class="built_in">RsyncWriteResp</span>(response, conn);</span><br><span class="line">    <span class="keyword">delete</span> []buffer;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  RsyncService::FileResponse* file_resp = response.<span class="built_in">mutable_file_resp</span>();</span><br><span class="line">  file_resp-&gt;<span class="built_in">set_data</span>(buffer, bytes_read);</span><br><span class="line">  file_resp-&gt;<span class="built_in">set_eof</span>(is_eof);</span><br><span class="line">  file_resp-&gt;<span class="built_in">set_checksum</span>(checksum);</span><br><span class="line">  file_resp-&gt;<span class="built_in">set_filename</span>(filename);</span><br><span class="line">  file_resp-&gt;<span class="built_in">set_count</span>(bytes_read);</span><br><span class="line">  file_resp-&gt;<span class="built_in">set_offset</span>(offset);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">RsyncWriteResp</span>(response, conn);</span><br><span class="line">  <span class="keyword">delete</span> []buffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="FAQ-12"><a href="#FAQ-12" class="headerlink" title="FAQ"></a>FAQ</h2><ul>
<li><p>这里为什么 snapshot 不能通过 Pb 传过去，而且复制完之后到从节点这边再去判断</p>
</li>
<li><p><code>s = writer-&gt;Write((uint64_t)offset, ret_count, resp-&gt;file_resp().data().c_str()); </code>这个是把数据写到哪里了</p>
</li>
<li><p><code>checksum</code> 有什么用</p>
<p>​</p>
</li>
</ul>
<h2 id="RsyncFile-总结"><a href="#RsyncFile-总结" class="headerlink" title="RsyncFile 总结"></a>RsyncFile 总结</h2><p>这里 Master 的 <code>FileRsync</code> 请求给从节点值包括 <code>db_name</code>, <code>slot_id</code>, <code>read_index</code>, <code>data</code>, <code>eof</code>, <code>checksum</code>, <code>filename</code>, <code>bytes_read</code>, <code>offset</code></p>
 <img width="778" alt="截屏2024-01-25 10 13 12" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/49e9778c-b48e-43ef-a4f2-b4764d223aaf">

<p>​</p>
<h2 id="TrySync"><a href="#TrySync" class="headerlink" title="TrySync"></a>TrySync</h2><p><strong>src&#x2F;pika_rm.cc</strong></p>
<p>在获取到所有的远端文件之后，Rsync 线程关闭，调用 <code>TryUpdateMasterOffset</code> 更新 <code>offset</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">PikaReplicaManager::RunSyncSlaveSlotStateMachine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="function">std::shared_lock <span class="title">l</span><span class="params">(slots_rw_)</span></span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; item : sync_slave_slots_) &#123;</span><br><span class="line">    SlotInfo p_info = item.first;</span><br><span class="line">    std::shared_ptr&lt;SyncSlaveSlot&gt; s_slot = item.second;</span><br><span class="line">    <span class="keyword">if</span> (s_slot-&gt;<span class="built_in">State</span>() == ReplState::kTryConnect) &#123;</span><br><span class="line">      <span class="built_in">SendSlotTrySyncRequest</span>(p_info.db_name_, p_info.slot_id_);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s_slot-&gt;<span class="built_in">State</span>() == ReplState::kTryDBSync) &#123;</span><br><span class="line">      <span class="built_in">SendSlotDBSyncRequest</span>(p_info.db_name_, p_info.slot_id_);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s_slot-&gt;<span class="built_in">State</span>() == ReplState::kWaitReply) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s_slot-&gt;<span class="built_in">State</span>() == ReplState::kWaitDBSync) &#123;</span><br><span class="line">      s_slot-&gt;<span class="built_in">ActivateRsync</span>();</span><br><span class="line">      std::shared_ptr&lt;Slot&gt; slot =</span><br><span class="line">          g_pika_server-&gt;<span class="built_in">GetDBSlotById</span>(p_info.db_name_, p_info.slot_id_);</span><br><span class="line">      <span class="keyword">if</span> (slot) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!s_slot-&gt;<span class="built_in">IsRsyncRunning</span>()) &#123;</span><br><span class="line">          slot-&gt;<span class="built_in">TryUpdateMasterOffset</span>();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Slot not found, DB Name: &quot;</span> &lt;&lt; p_info.db_name_</span><br><span class="line">                     &lt;&lt; <span class="string">&quot; Slot Id: &quot;</span> &lt;&lt; p_info.slot_id_;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s_slot-&gt;<span class="built_in">State</span>() == ReplState::kConnected || s_slot-&gt;<span class="built_in">State</span>() == ReplState::kNoConnect ||</span><br><span class="line">               s_slot-&gt;<span class="built_in">State</span>() == ReplState::kDBNoConnect) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>src&#x2F;pika_slot.cc</strong></p>
<p>这里会更新 <code>binlog</code> <code>offset</code> 的偏移量，我们会去去读取 <code>info</code> 文件，然后把 <code>info</code> 文件中的 <code>master_port</code>, <code>filenum</code>, <code>offset</code>, <code>term</code> , <code>index</code> 更新到从节点上，然后对 <code>info</code> 文件进行删除，这里调用 <code>ChaneDb</code> 将 <code>dbsync</code> 文件替换 <code>db</code> 文件夹，然后删除旧的 <code>db</code> 文件夹，然后将 <code>slot</code> 状态设置成 <code>kTryConnect</code>. 也就是说不管之前从节点的 <code>binlog</code> 写到哪里了，现在的从节点的偏移量和文件名是根据主节点传给他的偏移量和文件名的地方开始写</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Slot::TryUpdateMasterOffset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  std::string info_path = dbsync_path_ + kBgsaveInfoFile;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Got new binlog offset</span></span><br><span class="line">  <span class="function">std::ifstream <span class="title">is</span><span class="params">(info_path)</span></span>;</span><br><span class="line">  ...</span><br><span class="line">  std::string line;</span><br><span class="line">  std::string master_ip;</span><br><span class="line">  ...</span><br><span class="line">  is.<span class="built_in">close</span>();</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  pstd::<span class="built_in">DeleteFile</span>(info_path);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">ChangeDb</span>(dbsync_path_)) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Slot: &quot;</span> &lt;&lt; slot_name_ &lt;&lt; <span class="string">&quot;, Failed to change db&quot;</span>;</span><br><span class="line">    slave_slot-&gt;<span class="built_in">SetReplState</span>(ReplState::kError);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Update master offset</span></span><br><span class="line">  std::shared_ptr&lt;SyncMasterSlot&gt; master_slot =</span><br><span class="line">      g_pika_rm-&gt;<span class="built_in">GetSyncMasterSlotByName</span>(<span class="built_in">SlotInfo</span>(db_name_, slot_id_));</span><br><span class="line">  <span class="keyword">if</span> (!master_slot) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Master Slot: &quot;</span> &lt;&lt; slot_name_ &lt;&lt; <span class="string">&quot; not exist&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  master_slot-&gt;<span class="built_in">Logger</span>()-&gt;<span class="built_in">SetProducerStatus</span>(filenum, offset);</span><br><span class="line">  slave_slot-&gt;<span class="built_in">SetReplState</span>(ReplState::kTryConnect);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>src&#x2F;pika_rm.cc</strong></p>
<p>由于 <code>slot</code> 状态变更成了 <code>kTryConnect</code>， 这里调用 <code>SendSlotTrySyncRequest</code> 准备进行增量同步判断</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">PikaReplicaManager::RunSyncSlaveSlotStateMachine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="function">std::shared_lock <span class="title">l</span><span class="params">(slots_rw_)</span></span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; item : sync_slave_slots_) &#123;</span><br><span class="line">    SlotInfo p_info = item.first;</span><br><span class="line">    std::shared_ptr&lt;SyncSlaveSlot&gt; s_slot = item.second;</span><br><span class="line">    <span class="keyword">if</span> (s_slot-&gt;<span class="built_in">State</span>() == ReplState::kTryConnect) &#123;</span><br><span class="line">      <span class="built_in">SendSlotTrySyncRequest</span>(p_info.db_name_, p_info.slot_id_);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s_slot-&gt;<span class="built_in">State</span>() == ReplState::kTryDBSync) &#123;</span><br><span class="line">      <span class="built_in">SendSlotDBSyncRequest</span>(p_info.db_name_, p_info.slot_id_);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s_slot-&gt;<span class="built_in">State</span>() == ReplState::kWaitReply) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s_slot-&gt;<span class="built_in">State</span>() == ReplState::kWaitDBSync) &#123;</span><br><span class="line">      s_slot-&gt;<span class="built_in">ActivateRsync</span>();</span><br><span class="line">      std::shared_ptr&lt;Slot&gt; slot =</span><br><span class="line">          g_pika_server-&gt;<span class="built_in">GetDBSlotById</span>(p_info.db_name_, p_info.slot_id_);</span><br><span class="line">      <span class="keyword">if</span> (slot) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!s_slot-&gt;<span class="built_in">IsRsyncRunning</span>()) &#123;</span><br><span class="line">          slot-&gt;<span class="built_in">TryUpdateMasterOffset</span>();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Slot not found, DB Name: &quot;</span> &lt;&lt; p_info.db_name_</span><br><span class="line">                     &lt;&lt; <span class="string">&quot; Slot Id: &quot;</span> &lt;&lt; p_info.slot_id_;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s_slot-&gt;<span class="built_in">State</span>() == ReplState::kConnected || s_slot-&gt;<span class="built_in">State</span>() == ReplState::kNoConnect ||</span><br><span class="line">               s_slot-&gt;<span class="built_in">State</span>() == ReplState::kDBNoConnect) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>src&#x2F;pika_rm.cc</strong></p>
<p>这里调用 <code>SendSlotTrySync</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">PikaReplicaManager::SendSlotTrySyncRequest</span><span class="params">(<span class="type">const</span> std::string&amp; db_name, <span class="type">size_t</span> slot_id)</span> </span>&#123;</span><br><span class="line">  BinlogOffset boffset;</span><br><span class="line">  <span class="keyword">if</span> (!g_pika_server-&gt;<span class="built_in">GetDBSlotBinlogOffset</span>(db_name, slot_id, &amp;boffset)) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Slot: &quot;</span> &lt;&lt; db_name &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; slot_id &lt;&lt; <span class="string">&quot;,  Get Slot binlog offset failed&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">Corruption</span>(<span class="string">&quot;Slot get binlog offset error&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::shared_ptr&lt;SyncSlaveSlot&gt; slave_slot =</span><br><span class="line">      <span class="built_in">GetSyncSlaveSlotByName</span>(<span class="built_in">SlotInfo</span>(db_name, slot_id));</span><br><span class="line">  <span class="keyword">if</span> (!slave_slot) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Slave Slot: &quot;</span> &lt;&lt; db_name &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; slot_id &lt;&lt; <span class="string">&quot;, NotFound&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">Corruption</span>(<span class="string">&quot;Slave Slot not found&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Status status =</span><br><span class="line">      pika_repl_client_-&gt;<span class="built_in">SendSlotTrySync</span>(slave_slot-&gt;<span class="built_in">MasterIp</span>(), slave_slot-&gt;<span class="built_in">MasterPort</span>(), db_name,</span><br><span class="line">                                              slot_id, boffset, slave_slot-&gt;<span class="built_in">LocalIp</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (status.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">    slave_slot-&gt;<span class="built_in">SetReplState</span>(ReplState::kWaitReply);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    slave_slot-&gt;<span class="built_in">SetReplState</span>(ReplState::kError);</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;SendSlotTrySyncRequest failed &quot;</span> &lt;&lt; status.<span class="built_in">ToString</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>src&#x2F;pika_repl_client.cc</strong></p>
<p>在 <code>TrySync</code> 请求中设置了 <code>Binlog_offset</code>, <code>Binlog_filnum</code>, <code>ip</code>, <code>port</code>, <code>db_name</code>, <code>slot_id</code>发送给 Master</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">PikaReplClient::SendSlotTrySync</span><span class="params">(<span class="type">const</span> std::string&amp; ip, <span class="type">uint32_t</span> port, <span class="type">const</span> std::string&amp; db_name,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            <span class="type">uint32_t</span> slot_id, <span class="type">const</span> BinlogOffset&amp; boffset,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            <span class="type">const</span> std::string&amp; local_ip)</span> </span>&#123;</span><br><span class="line">  InnerMessage::InnerRequest request;</span><br><span class="line">  request.<span class="built_in">set_type</span>(InnerMessage::kTrySync);</span><br><span class="line">  InnerMessage::InnerRequest::TrySync* try_sync = request.<span class="built_in">mutable_try_sync</span>();</span><br><span class="line">  InnerMessage::Node* node = try_sync-&gt;<span class="built_in">mutable_node</span>();</span><br><span class="line">  node-&gt;<span class="built_in">set_ip</span>(local_ip);</span><br><span class="line">  node-&gt;<span class="built_in">set_port</span>(g_pika_server-&gt;<span class="built_in">port</span>());</span><br><span class="line">  InnerMessage::Slot* slot = try_sync-&gt;<span class="built_in">mutable_slot</span>();</span><br><span class="line">  slot-&gt;<span class="built_in">set_db_name</span>(db_name);</span><br><span class="line">  slot-&gt;<span class="built_in">set_slot_id</span>(slot_id);</span><br><span class="line"></span><br><span class="line">  InnerMessage::BinlogOffset* binlog_offset = try_sync-&gt;<span class="built_in">mutable_binlog_offset</span>();</span><br><span class="line">  binlog_offset-&gt;<span class="built_in">set_filenum</span>(boffset.filenum);</span><br><span class="line">  binlog_offset-&gt;<span class="built_in">set_offset</span>(boffset.offset);</span><br><span class="line"></span><br><span class="line">  std::string to_send;</span><br><span class="line">  <span class="keyword">if</span> (!request.<span class="built_in">SerializeToString</span>(&amp;to_send)) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Serialize Slot TrySync Request Failed, to Master (&quot;</span> &lt;&lt; ip &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; port &lt;&lt; <span class="string">&quot;)&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">Corruption</span>(<span class="string">&quot;Serialize Failed&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> client_thread_-&gt;<span class="built_in">Write</span>(ip, <span class="built_in">static_cast</span>&lt;<span class="type">int32_t</span>&gt;(port + kPortShiftReplServer), to_send);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>小结</strong></p>
<p>在 <code>TrySync</code> 中，从节点给主节点发送的信息有 <code>ip</code>, <code>port</code>, <code>db_name</code>, <code>slot_id</code>, <code>filenum</code>,<code>offset</code></p>
<p><strong>src&#x2F;pika_repl_server_conn.cc</strong></p>
<p>主节点收到从节点发来的 <code>TrySync</code> 请求后，调用 <code>TrySyncOffsetCheck</code> 判断是否需要全量同步</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PikaReplServerConn::HandleTrySyncRequest</span><span class="params">(<span class="type">void</span>* arg)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="type">bool</span> pre_success = <span class="literal">true</span>;</span><br><span class="line">  ...</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pre_success) &#123;</span><br><span class="line">    pre_success = <span class="built_in">TrySyncOffsetCheck</span>(slot, try_sync_request, try_sync_response);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (pre_success) &#123;</span><br><span class="line">    pre_success = <span class="built_in">TrySyncUpdateSlaveNode</span>(slot, try_sync_request, conn, try_sync_response);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::string reply_str;</span><br><span class="line">  <span class="keyword">if</span> (!response.<span class="built_in">SerializeToString</span>(&amp;reply_str) || (conn-&gt;<span class="built_in">WriteResp</span>(reply_str) != <span class="number">0</span>)) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Handle Try Sync Failed&quot;</span>;</span><br><span class="line">    conn-&gt;<span class="built_in">NotifyClose</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  conn-&gt;<span class="built_in">NotifyWrite</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="FAQ-13"><a href="#FAQ-13" class="headerlink" title="FAQ"></a>FAQ</h2><ul>
<li><p><code>req-&gt;has_consensus_meta()</code> 是什么</p>
<p>是 proto 文件里面定义的东西</p>
<p>​</p>
</li>
</ul>
<p><strong>src&#x2F;pika_repl_server_conn.cc</strong></p>
<p>在这里主节点将自己的 <code>filenum</code> 和 <code>offset</code> 与从节点的 <code>filenum</code> 和 <code>offset</code> 进行比较，如果从节点数据比主节点新，返回值为 <code>kSyncPointLarger</code> , 如果从节点传过来的 <code>binlog</code> 在主节点这里已经被删除的情况，返回值为 <code>kSyncPointBePurged</code>，需要做全量同步，如果从节点的点位和主节点的点位对应不上，则不能做同步，返回值为 <code>kError</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">PikaReplServerConn::TrySyncOffsetCheck</span><span class="params">(<span class="type">const</span> std::shared_ptr&lt;SyncMasterSlot&gt;&amp; slot,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            <span class="type">const</span> InnerMessage::InnerRequest::TrySync&amp; try_sync_request,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            InnerMessage::InnerResponse::TrySync* try_sync_response)</span> </span>&#123;</span><br><span class="line">  <span class="type">const</span> InnerMessage::Node&amp; node = try_sync_request.<span class="built_in">node</span>();</span><br><span class="line">  <span class="type">const</span> InnerMessage::BinlogOffset&amp; slave_boffset = try_sync_request.<span class="built_in">binlog_offset</span>();</span><br><span class="line">  std::string slot_name = slot-&gt;<span class="built_in">SlotName</span>();</span><br><span class="line"></span><br><span class="line">  BinlogOffset boffset;</span><br><span class="line">  Status s = slot-&gt;<span class="built_in">Logger</span>()-&gt;<span class="built_in">GetProducerStatus</span>(&amp;(boffset.filenum), &amp;(boffset.offset));</span><br><span class="line">  ...</span><br><span class="line">  InnerMessage::BinlogOffset* master_slot_boffset = try_sync_response-&gt;<span class="built_in">mutable_binlog_offset</span>();</span><br><span class="line">  master_slot_boffset-&gt;<span class="built_in">set_filenum</span>(boffset.filenum);</span><br><span class="line">  master_slot_boffset-&gt;<span class="built_in">set_offset</span>(boffset.offset);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (boffset.filenum &lt; slave_boffset.<span class="built_in">filenum</span>() ||</span><br><span class="line">      (boffset.filenum == slave_boffset.<span class="built_in">filenum</span>() &amp;&amp; boffset.offset &lt; slave_boffset.<span class="built_in">offset</span>())) &#123;</span><br><span class="line">    try_sync_response-&gt;<span class="built_in">set_reply_code</span>(InnerMessage::InnerResponse::TrySync::kSyncPointLarger);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::string confile = <span class="built_in">NewFileName</span>(slot-&gt;<span class="built_in">Logger</span>()-&gt;<span class="built_in">filename</span>(), slave_boffset.<span class="built_in">filenum</span>());</span><br><span class="line">  <span class="keyword">if</span> (!pstd::<span class="built_in">FileExists</span>(confile)) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Slot: &quot;</span> &lt;&lt; slot_name &lt;&lt; <span class="string">&quot; binlog has been purged, may need full sync&quot;</span>;</span><br><span class="line">    try_sync_response-&gt;<span class="built_in">set_reply_code</span>(InnerMessage::InnerResponse::TrySync::kSyncPointBePurged);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  PikaBinlogReader reader;</span><br><span class="line">  reader.<span class="built_in">Seek</span>(slot-&gt;<span class="built_in">Logger</span>(), slave_boffset.<span class="built_in">filenum</span>(), slave_boffset.<span class="built_in">offset</span>());</span><br><span class="line">  BinlogOffset seeked_offset;</span><br><span class="line">  reader.<span class="built_in">GetReaderStatus</span>(&amp;(seeked_offset.filenum), &amp;(seeked_offset.offset));</span><br><span class="line">  <span class="keyword">if</span> (seeked_offset.filenum != slave_boffset.<span class="built_in">filenum</span>() || seeked_offset.offset != slave_boffset.<span class="built_in">offset</span>()) &#123;</span><br><span class="line">    try_sync_response-&gt;<span class="built_in">set_reply_code</span>(InnerMessage::InnerResponse::TrySync::kError);</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="FAQ-14"><a href="#FAQ-14" class="headerlink" title="FAQ"></a>FAQ</h2><ul>
<li><p>这里的 seek 的作用是什么</p>
<p>使主节点的 <code>Binlog</code> 同步点位和从节点的点位对应上</p>
<p>​</p>
</li>
</ul>
<p><strong>src&#x2F;pika_repl_server_conn.cc</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">PikaReplServerConn::TrySyncUpdateSlaveNode</span><span class="params">(<span class="type">const</span> std::shared_ptr&lt;SyncMasterSlot&gt;&amp; slot,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                <span class="type">const</span> InnerMessage::InnerRequest::TrySync&amp; try_sync_request,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                <span class="type">const</span> std::shared_ptr&lt;net::PbConn&gt;&amp; conn,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                InnerMessage::InnerResponse::TrySync* try_sync_response)</span> </span>&#123;</span><br><span class="line">  <span class="type">const</span> InnerMessage::Node&amp; node = try_sync_request.<span class="built_in">node</span>();</span><br><span class="line">  std::string slot_name = slot-&gt;<span class="built_in">SlotName</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!slot-&gt;<span class="built_in">CheckSlaveNodeExist</span>(node.<span class="built_in">ip</span>(), node.<span class="built_in">port</span>())) &#123;</span><br><span class="line">    <span class="type">int32_t</span> session_id = slot-&gt;<span class="built_in">GenSessionId</span>();</span><br><span class="line">    <span class="keyword">if</span> (session_id == <span class="number">-1</span>) &#123;</span><br><span class="line">      try_sync_response-&gt;<span class="built_in">set_reply_code</span>(InnerMessage::InnerResponse::TrySync::kError);</span><br><span class="line">      <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Slot: &quot;</span> &lt;&lt; slot_name &lt;&lt; <span class="string">&quot;, Gen Session id Failed&quot;</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    try_sync_response-&gt;<span class="built_in">set_session_id</span>(session_id);</span><br><span class="line">    <span class="comment">// incremental sync</span></span><br><span class="line">    Status s = slot-&gt;<span class="built_in">AddSlaveNode</span>(node.<span class="built_in">ip</span>(), node.<span class="built_in">port</span>(), session_id);</span><br><span class="line">    <span class="keyword">if</span> (!s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">      try_sync_response-&gt;<span class="built_in">set_reply_code</span>(InnerMessage::InnerResponse::TrySync::kError);</span><br><span class="line">      <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Slot: &quot;</span> &lt;&lt; slot_name &lt;&lt; <span class="string">&quot; TrySync Failed, &quot;</span> &lt;&lt; s.<span class="built_in">ToString</span>();</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> std::string ip_port = pstd::<span class="built_in">IpPortString</span>(node.<span class="built_in">ip</span>(), node.<span class="built_in">port</span>());</span><br><span class="line">    g_pika_rm-&gt;<span class="built_in">ReplServerUpdateClientConnMap</span>(ip_port, conn-&gt;<span class="built_in">fd</span>());</span><br><span class="line">    try_sync_response-&gt;<span class="built_in">set_reply_code</span>(InnerMessage::InnerResponse::TrySync::kOk);</span><br><span class="line">    <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Slot: &quot;</span> &lt;&lt; slot_name &lt;&lt; <span class="string">&quot; TrySync Success, Session: &quot;</span> &lt;&lt; session_id;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="type">int32_t</span> session_id;</span><br><span class="line">    Status s = slot-&gt;<span class="built_in">GetSlaveNodeSession</span>(node.<span class="built_in">ip</span>(), node.<span class="built_in">port</span>(), &amp;session_id);</span><br><span class="line">    <span class="keyword">if</span> (!s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">      try_sync_response-&gt;<span class="built_in">set_reply_code</span>(InnerMessage::InnerResponse::TrySync::kError);</span><br><span class="line">      <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Slot: &quot;</span> &lt;&lt; slot_name &lt;&lt; <span class="string">&quot;, Get Session id Failed&quot;</span> &lt;&lt; s.<span class="built_in">ToString</span>();</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    try_sync_response-&gt;<span class="built_in">set_reply_code</span>(InnerMessage::InnerResponse::TrySync::kOk);</span><br><span class="line">    try_sync_response-&gt;<span class="built_in">set_session_id</span>(session_id);</span><br><span class="line">    <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Slot: &quot;</span> &lt;&lt; slot_name &lt;&lt; <span class="string">&quot; TrySync Success, Session: &quot;</span> &lt;&lt; session_id;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="TrySync总结"><a href="#TrySync总结" class="headerlink" title="TrySync总结"></a>TrySync总结</h2><p> <code>TrySync</code> 中主节点给从节点回包包括 <code>session_id</code>, <code>db_name</code>, <code>slot_id</code></p>
<img width="797" alt="截屏2024-01-25 10 13 35" src="https://github.com/OpenAtomFoundation/pika/assets/73943232/bf381574-4175-4b02-a948-a6d2c442667f">





<h2 id="BinlogSync"><a href="#BinlogSync" class="headerlink" title="BinlogSync"></a>BinlogSync</h2><p><strong>src&#x2F;pika_repl_client_conn.cc</strong></p>
<p>在 <code>TrySync</code> 回包中根据 Master 的返回值去更新 <code>slave_slot</code> 的状态，如果成功置为 <code>kConnected</code> ，然后发送 <code>SendSlotBinlogSyncAckRequest</code> ，如果返回状态是 <code>kSyncPointBePurged</code> 那就需要重新进行全量复制操作状态流转到 <code>kTryDBSync</code>，如果返回状态是 <code>kSyncPointLarger</code> 则说明从节点数据比主节点要新，不能继续进行主从复制,  至此全量同步已经完成</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PikaReplClientConn::HandleTrySyncResponse</span><span class="params">(<span class="type">void</span>* arg)</span> </span>&#123;</span><br><span class="line">  <span class="function">std::unique_ptr&lt;ReplClientTaskArg&gt; <span class="title">task_arg</span><span class="params">(<span class="keyword">static_cast</span>&lt;ReplClientTaskArg*&gt;(arg))</span></span>;</span><br><span class="line">  std::shared_ptr&lt;net::PbConn&gt; conn = task_arg-&gt;conn;</span><br><span class="line">  std::shared_ptr&lt;InnerMessage::InnerResponse&gt; response = task_arg-&gt;res;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> InnerMessage::InnerResponse_TrySync&amp; try_sync_response = response-&gt;<span class="built_in">try_sync</span>();</span><br><span class="line">  <span class="type">const</span> InnerMessage::Slot&amp; slot_response = try_sync_response.<span class="built_in">slot</span>();</span><br><span class="line">  ...</span><br><span class="line">  LogicOffset logic_last_offset;</span><br><span class="line">  ...</span><br><span class="line">  std::string slot_name = slot-&gt;<span class="built_in">SlotName</span>();</span><br><span class="line">  <span class="keyword">if</span> (try_sync_response.<span class="built_in">reply_code</span>() == InnerMessage::InnerResponse::TrySync::kOk) &#123;</span><br><span class="line">    BinlogOffset boffset;</span><br><span class="line">    <span class="type">int32_t</span> session_id = try_sync_response.<span class="built_in">session_id</span>();</span><br><span class="line">    slot-&gt;<span class="built_in">Logger</span>()-&gt;<span class="built_in">GetProducerStatus</span>(&amp;boffset.filenum, &amp;boffset.offset);</span><br><span class="line">    slave_slot-&gt;<span class="built_in">SetMasterSessionId</span>(session_id);</span><br><span class="line">    <span class="function">LogOffset <span class="title">offset</span><span class="params">(boffset, logic_last_offset)</span></span>;</span><br><span class="line">    g_pika_rm-&gt;<span class="built_in">SendSlotBinlogSyncAckRequest</span>(db_name, slot_id, offset, offset, <span class="literal">true</span>);</span><br><span class="line">    slave_slot-&gt;<span class="built_in">SetReplState</span>(ReplState::kConnected);</span><br><span class="line">    <span class="comment">// after connected, update receive time first to avoid connection timeout</span></span><br><span class="line">    slave_slot-&gt;<span class="built_in">SetLastRecvTime</span>(pstd::<span class="built_in">NowMicros</span>());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Slot: &quot;</span> &lt;&lt; slot_name &lt;&lt; <span class="string">&quot; TrySync Ok&quot;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (try_sync_response.<span class="built_in">reply_code</span>() == InnerMessage::InnerResponse::TrySync::kSyncPointBePurged) &#123;</span><br><span class="line">    slave_slot-&gt;<span class="built_in">SetReplState</span>(ReplState::kTryDBSync);</span><br><span class="line">    <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Slot: &quot;</span> &lt;&lt; slot_name &lt;&lt; <span class="string">&quot; Need To Try DBSync&quot;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (try_sync_response.<span class="built_in">reply_code</span>() == InnerMessage::InnerResponse::TrySync::kSyncPointLarger) &#123;</span><br><span class="line">    slave_slot-&gt;<span class="built_in">SetReplState</span>(ReplState::kError);</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Slot: &quot;</span> &lt;&lt; slot_name &lt;&lt; <span class="string">&quot; TrySync Error, Because the invalid filenum and offset&quot;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (try_sync_response.<span class="built_in">reply_code</span>() == InnerMessage::InnerResponse::TrySync::kError) &#123;</span><br><span class="line">    slave_slot-&gt;<span class="built_in">SetReplState</span>(ReplState::kError);</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Slot: &quot;</span> &lt;&lt; slot_name &lt;&lt; <span class="string">&quot; TrySync Error&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>src&#x2F;pika_rm.cc</strong></p>
<p>调用 <code>SendSlotBinlogSync</code> 去发起增量同步请求</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">PikaReplicaManager::SendSlotBinlogSyncAckRequest</span><span class="params">(<span class="type">const</span> std::string&amp; db, <span class="type">uint32_t</span> slot_id,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                             <span class="type">const</span> LogOffset&amp; ack_start, <span class="type">const</span> LogOffset&amp; ack_end,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                             <span class="type">bool</span> is_first_send)</span> </span>&#123;</span><br><span class="line">  std::shared_ptr&lt;SyncSlaveSlot&gt; slave_slot = <span class="built_in">GetSyncSlaveSlotByName</span>(<span class="built_in">SlotInfo</span>(db, slot_id));</span><br><span class="line">  <span class="keyword">if</span> (!slave_slot) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Slave Slot: &quot;</span> &lt;&lt; db &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; slot_id &lt;&lt; <span class="string">&quot;, NotFound&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">Corruption</span>(<span class="string">&quot;Slave Slot not found&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> pika_repl_client_-&gt;<span class="built_in">SendSlotBinlogSync</span>(slave_slot-&gt;<span class="built_in">MasterIp</span>(), slave_slot-&gt;<span class="built_in">MasterPort</span>(), db,</span><br><span class="line">                                                    slot_id, ack_start, ack_end, slave_slot-&gt;<span class="built_in">LocalIp</span>(),</span><br><span class="line">                                                    is_first_send);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>src&#x2F;pika_repl_client.cc</strong></p>
<p>这里由于从节点是第一次发 <code>BinlogSync</code> 请求所以 <code>BinlogOffset</code> 的 <code>ack_range_start</code>  和 <code>ack_range_end</code>  都是相等的，都是全量同步之后，<code>info</code> 文件里的 <code>Master</code> 执行 dump 操作的时候的同步点位</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">PikaReplClient::SendSlotBinlogSync</span><span class="params">(<span class="type">const</span> std::string&amp; ip, <span class="type">uint32_t</span> port, <span class="type">const</span> std::string&amp; db_name,</span></span></span><br><span class="line"><span class="params"><span class="function">                                               <span class="type">uint32_t</span> slot_id, <span class="type">const</span> LogOffset&amp; ack_start,</span></span></span><br><span class="line"><span class="params"><span class="function">                                               <span class="type">const</span> LogOffset&amp; ack_end, <span class="type">const</span> std::string&amp; local_ip,</span></span></span><br><span class="line"><span class="params"><span class="function">                                               <span class="type">bool</span> is_first_send)</span> </span>&#123;</span><br><span class="line">  InnerMessage::InnerRequest request;</span><br><span class="line">  request.<span class="built_in">set_type</span>(InnerMessage::kBinlogSync);</span><br><span class="line">  InnerMessage::InnerRequest::BinlogSync* binlog_sync = request.<span class="built_in">mutable_binlog_sync</span>();</span><br><span class="line">  InnerMessage::Node* node = binlog_sync-&gt;<span class="built_in">mutable_node</span>();</span><br><span class="line">  node-&gt;<span class="built_in">set_ip</span>(local_ip);</span><br><span class="line">  node-&gt;<span class="built_in">set_port</span>(g_pika_server-&gt;<span class="built_in">port</span>());</span><br><span class="line">  binlog_sync-&gt;<span class="built_in">set_db_name</span>(db_name);</span><br><span class="line">  binlog_sync-&gt;<span class="built_in">set_slot_id</span>(slot_id);</span><br><span class="line">  binlog_sync-&gt;<span class="built_in">set_first_send</span>(is_first_send);</span><br><span class="line"></span><br><span class="line">  InnerMessage::BinlogOffset* ack_range_start = binlog_sync-&gt;<span class="built_in">mutable_ack_range_start</span>();</span><br><span class="line">  ack_range_start-&gt;<span class="built_in">set_filenum</span>(ack_start.b_offset.filenum);</span><br><span class="line">  ack_range_start-&gt;<span class="built_in">set_offset</span>(ack_start.b_offset.offset);</span><br><span class="line">  ack_range_start-&gt;<span class="built_in">set_term</span>(ack_start.l_offset.term);</span><br><span class="line">  ack_range_start-&gt;<span class="built_in">set_index</span>(ack_start.l_offset.index);</span><br><span class="line"></span><br><span class="line">  InnerMessage::BinlogOffset* ack_range_end = binlog_sync-&gt;<span class="built_in">mutable_ack_range_end</span>();</span><br><span class="line">  ack_range_end-&gt;<span class="built_in">set_filenum</span>(ack_end.b_offset.filenum);</span><br><span class="line">  ack_range_end-&gt;<span class="built_in">set_offset</span>(ack_end.b_offset.offset);</span><br><span class="line">  ack_range_end-&gt;<span class="built_in">set_term</span>(ack_end.l_offset.term);</span><br><span class="line">  ack_range_end-&gt;<span class="built_in">set_index</span>(ack_end.l_offset.index);</span><br><span class="line"></span><br><span class="line">  std::shared_ptr&lt;SyncSlaveSlot&gt; slave_slot =</span><br><span class="line">      g_pika_rm-&gt;<span class="built_in">GetSyncSlaveSlotByName</span>(<span class="built_in">SlotInfo</span>(db_name, slot_id));</span><br><span class="line">  <span class="keyword">if</span> (!slave_slot) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Slave Slot: &quot;</span> &lt;&lt; db_name &lt;&lt; <span class="string">&quot;_&quot;</span> &lt;&lt; slot_id &lt;&lt; <span class="string">&quot; not exist&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">NotFound</span>(<span class="string">&quot;SyncSlaveSlot NotFound&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">int32_t</span> session_id = slave_slot-&gt;<span class="built_in">MasterSessionId</span>();</span><br><span class="line">  binlog_sync-&gt;<span class="built_in">set_session_id</span>(session_id);</span><br><span class="line"></span><br><span class="line">  std::string to_send;</span><br><span class="line">  <span class="keyword">if</span> (!request.<span class="built_in">SerializeToString</span>(&amp;to_send)) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Serialize Slot BinlogSync Request Failed, to Master (&quot;</span> &lt;&lt; ip &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; port &lt;&lt; <span class="string">&quot;)&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> Status::<span class="built_in">Corruption</span>(<span class="string">&quot;Serialize Failed&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> client_thread_-&gt;<span class="built_in">Write</span>(ip, <span class="built_in">static_cast</span>&lt;<span class="type">int32_t</span>&gt;(port + kPortShiftReplServer), to_send);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>小结</strong></p>
<p>这里的 <code>kBinlogSync</code> 请求中，从节点向主节点传递 <code>ip</code>, <code>port</code>, <code>slot_id</code>, <code>is_first_send</code>, <code>filenum</code> , <code>offset</code>, <code>term</code>, <code>index</code>, <code>session_id</code>, <code>db_name</code></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上就是全量同步的全部过程，增量同步将放到下篇文章进行讲解~</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/09/Pika%E7%9A%84%E5%85%A8%E9%87%8F%E5%90%8C%E6%AD%A5/" data-id="clrsl0ixf001hh9rfentifohu" data-title="Pika的全量同步源码剖析" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Blog/" rel="tag">Blog</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2024/01/15/C++%E9%94%81%E6%9C%BA%E5%88%B6/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          C++锁机制
        
      </div>
    </a>
  
  
    <a href="/2024/01/04/Pika%E7%9A%84%E5%A2%9E%E9%87%8F%E5%90%8C%E6%AD%A5/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Pika的增量同步源码剖析</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Blog/" rel="tag">Blog</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Blog/" style="font-size: 10px;">Blog</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">November 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">October 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">August 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/01/15/C++%E9%94%81%E6%9C%BA%E5%88%B6/">C++锁机制</a>
          </li>
        
          <li>
            <a href="/2024/01/09/Pika%E7%9A%84%E5%85%A8%E9%87%8F%E5%90%8C%E6%AD%A5/">Pika的全量同步源码剖析</a>
          </li>
        
          <li>
            <a href="/2024/01/04/Pika%E7%9A%84%E5%A2%9E%E9%87%8F%E5%90%8C%E6%AD%A5/">Pika的增量同步源码剖析</a>
          </li>
        
          <li>
            <a href="/2023/12/05/Floyd%E6%97%A0%E6%95%88%E6%95%B0%E6%8D%AE%E6%B8%85%E7%90%86%E6%96%B9%E6%A1%88/">Floyd无效数据清理方案</a>
          </li>
        
          <li>
            <a href="/2023/12/04/Pika%E5%BF%AB%E6%85%A2%E5%91%BD%E4%BB%A4%E5%88%86%E7%A6%BB%E6%96%B9%E6%A1%88/">Pika快慢命令分离方案</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>